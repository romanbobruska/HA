# sensors:
# NIBE

- name: "Nibe - Plánovaný režim provozu"
  unique_id: nibe_status_rezim_provozu
  state: >
    {% set topeni = states('sensor.nibe_stav_topeni') | int(0) == 1 %}
    {% set chlazeni = states('sensor.nibe_stav_chlazeni') | int(0) == 1 %}
    {% set voda = states('sensor.nibe_stav_tuv') | int(0) == 1 %}

    {% set ns = namespace(res=[]) %}
    {% if topeni %}{% set ns.res = ns.res + ["Vytápění"] %}{% endif %}
    {% if chlazeni %}{% set ns.res = ns.res + ["Chlazení"] %}{% endif %}
    {% if voda %}{% set ns.res = ns.res + ["Ohřev vody"] %}{% endif %}

    {% if ns.res | length > 0 %}
      {{ ns.res | join(" + ") }}
    {% else %}
      Nečinnost (Standby)
    {% endif %}
  icon: >
    {% set topeni = states('sensor.nibe_stav_topeni') | int(0) == 1 %}
    {% set chlazeni = states('sensor.nibe_stav_chlazeni') | int(0) == 1 %}
    {% set voda = states('sensor.nibe_stav_tuv') | int(0) == 1 %}

    {% if topeni and voda %} mdi:home-thermometer-outline
    {% elif chlazeni and voda %} mdi:snowflake-thermometer
    {% elif topeni %} mdi:radiator
    {% elif chlazeni %} mdi:snowflake
    {% elif voda %} mdi:water-boiler
    {% else %} mdi:power-sleep
    {% endif %}
  attributes:
    posledni_zmena: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

- name: "Nibe - Aktuální reálný stav"
  unique_id: nibe_realny_stav
  icon: >
    {# Cpr Status 43434/43435: 0=Off, 1=On #}
    {% set cpr14 = states('sensor.nibe_kompresor_ep14_zapnuty') | int(0) %}
    {% set cpr15 = states('sensor.nibe_kompresor_ep15_zapnuty') | int(0) %}
    {% if cpr14 == 1 or cpr15 == 1 %}
      mdi:heat-pump
    {% else %}
      mdi:pause-circle-outline
    {% endif %}
  state: >
    {# Cpr Status 43434/43435: 0=Off, 1=On #}
    {% set cpr14 = states('sensor.nibe_kompresor_ep14_zapnuty') | int(0) %}
    {% set cpr15 = states('sensor.nibe_kompresor_ep15_zapnuty') | int(0) %}
    {# Prio 43086: 10=Off, 20=HW, 30=Heat, 40=Pool, 50=Transfer, 60=Cooling #}
    {% set prio = states('sensor.nibe_priorita_provozu_real') | int(0) %}
    {# Compressor State 43426/43427: 20=Stopped, 40=Starting, 60=Running, 100=Stopping #}
    {% set state14 = states('sensor.nibe_stav_ep14') | int(0) %}
    {% set state15 = states('sensor.nibe_stav_ep15') | int(0) %}

    {% if cpr14 == 1 or cpr15 == 1 %}
      {% if prio == 30 %}
        PRACUJE: Vytápění domu
      {% elif prio == 20 %}
        PRACUJE: Ohřev vody (TUV)
      {% elif prio == 60 %}
        PRACUJE: Chlazení
      {% elif prio == 40 %}
        PRACUJE: Ohřev bazénu
      {% elif prio == 50 %}
        PRACUJE: Přenos tepla
      {% else %}
        PRACUJE: Aktivní (Priorita {{ prio }})
      {% endif %}
    {% else %}
      Klidový stav (kompresory stojí)
    {% endif %}
  attributes:
    cpr14_on: "{{ states('sensor.nibe_kompresor_ep14_zapnuty') }}"
    cpr15_on: "{{ states('sensor.nibe_kompresor_ep15_zapnuty') }}"
    ep14_state: "{{ states('sensor.nibe_stav_ep14') }}"
    ep15_state: "{{ states('sensor.nibe_stav_ep15') }}"
    priorita: "{{ states('sensor.nibe_priorita_provozu_real') }}"

- name: "Nibe - Režim komfortu TUV popis"
  unique_id: nibe_rezim_komfortu_tuv_popis
  icon: mdi:water-thermometer
  state: >
    {% set val = states('sensor.nibe_rezim_komfortu_tuv') | int(-1) %}
    {% if val == 0 %} Ekonomický (2°C)
    {% elif val == 1 %} Normální (3°C)
    {% elif val == 2 %} Luxusní (10°C)
    {% elif val == 4 %} Smart Control
    {% else %} Neznámý ({{ val }})
    {% endif %}

#FVE

- name: "Stav wallboxu garáž popis"
  unique_id: "evcharger_state_garage_desc"
  state: >
    {% set val = states('sensor.charger_state_garage') | int(-1) %}
    {% set mapper = {
      0: 'Disconnected', 1: 'Connected', 2: 'Charging', 3: 'Charged',
      4: 'Waiting for sun', 5: 'Waiting for RFID', 6: 'Waiting for start',
      7: 'Low SOC', 8: 'Ground test error', 9: 'Welded contacts error',
      10: 'CP test error', 11: 'Residual current', 12: 'Undervoltage',
      13: 'Overvoltage', 14: 'Overheating', 20: 'Charging limit'
    } %}
    {{ mapper.get(val, "Error - No Data") }}
  icon: >
    {% set val = states('sensor.charger_state_garage') | int(-1) %}
    {% if val == 0 %} mdi:ev-plug-ccs2
    {% elif val == 1 %} mdi:ev-station
    {% elif val == 2 %} mdi:battery-charging-100
    {% elif val == 3 %} mdi:battery-check
    {% elif val == 4 %} mdi:solar-power
    {% elif val == 5 %} mdi:card-account-details
    {% elif val == 6 %} mdi:play-circle-outline
    {% elif val == 7 %} mdi:battery-alert
    {% elif val >= 8 and val <= 14 %} mdi:alert-octagon
    {% elif val == 20 %} mdi:speedometer-slow
    {% else %} mdi:help-circle
    {% endif %}

- name: "Stav wallboxu venek popis"
  unique_id: "evcharger_state_out_desc"
  state: >
    {% set val = states('sensor.charger_state_out') | int(-1) %}
    {% set mapper = {
      0: 'Disconnected', 1: 'Connected', 2: 'Charging', 3: 'Charged',
      4: 'Waiting for sun', 5: 'Waiting for RFID', 6: 'Waiting for start',
      7: 'Low SOC', 8: 'Ground test error', 9: 'Welded contacts error',
      10: 'CP test error', 11: 'Residual current', 12: 'Undervoltage',
      13: 'Overvoltage', 14: 'Overheating', 20: 'Charging limit'
    } %}
    {{ mapper.get(val, "Error - No Data") }}
  icon: >
    {% set val = states('sensor.charger_state_out') | int(-1) %}
    {% if val == 0 %} mdi:ev-plug-ccs2
    {% elif val == 1 %} mdi:ev-station
    {% elif val == 2 %} mdi:battery-charging-100
    {% elif val == 3 %} mdi:battery-check
    {% elif val == 4 %} mdi:solar-power
    {% elif val == 5 %} mdi:card-account-details
    {% elif val == 6 %} mdi:play-circle-outline
    {% elif val == 7 %} mdi:battery-alert
    {% elif val >= 8 and val <= 14 %} mdi:alert-octagon
    {% elif val == 20 %} mdi:speedometer-slow
    {% else %} mdi:help-circle
    {% endif %}

- name: "Spotřeba dnes ze sítě"
  unique_id: "spotreba_dnes_ze_site"
  unit_of_measurement: "kWh"
  device_class: energy
  state_class: total_increasing
  icon: mdi:chart-histogram
  state: "{{ states('input_number.spotreba_dnes_sit') | float(0) }}"

- name: "Spotřeba dnes auto"
  unique_id: "spotreba_dnes_auto"
  unit_of_measurement: "kWh"
  device_class: energy
  state_class: total_increasing
  icon: mdi:chart-histogram
  state: "{{ states('input_number.spotreba_dnes_auto') | float(0) }}"

- name: "Solární výroba dnes"
  unique_id: "solarni_vyroba_dnes"
  unit_of_measurement: "kWh"
  device_class: energy
  state_class: total_increasing
  icon: mdi:chart-histogram
  state: "{{ states('input_number.vyroba_dnes') | float(0) }}"

- name: "Nabíjení baterií dnes"
  unique_id: "nabijeni_baterii_total"
  unit_of_measurement: "kWh"
  device_class: energy
  state_class: total_increasing
  icon: mdi:chart-histogram
  state: "{{ states('input_number.nabijeni_baterie_dnes') | float(0) }}"

- name: "Vybíjení baterií dnes"
  unique_id: "vybijeni_baterii_total"
  unit_of_measurement: "kWh"
  device_class: energy
  state_class: total_increasing
  icon: mdi:chart-histogram
  state: "{{ states('input_number.vybijeni_baterie_dnes') | float(0) }}"

- name: "Prodej do sítě dnes"
  unique_id: "prodej_dos_site_dnes"
  unit_of_measurement: "kWh"
  device_class: energy
  state_class: total_increasing
  icon: mdi:chart-histogram
  state: "{{ states('input_number.prodej_do_site_dnes') | float(0) }}"

#Řízení FVE
- name: "FVE Aktuální mód"
  unique_id: fve_aktualni_mod
  icon: mdi:state-machine
  state: "{{ states('input_select.fve_manual_mod') if states('input_select.fve_manual_mod') != 'auto' else states('sensor.fve_planovany_mod') }}"

- name: "FVE Plánovaný mód"
  unique_id: fve_planovany_mod
  icon: mdi:calendar-clock
  state: "{{ state_attr('sensor.fve_plan', 'current_mode') | default('normal') }}"

- name: "FVE Rozdíl výroby a spotřeby"
  unique_id: fve_rozdil_vyroby_a_spotreby
  icon: mdi:scale-balance
  unit_of_measurement: "W"
  device_class: power
  state: >
    {% set vyroba = states('sensor.vyroba_fve') | float(0) %}
    {% set spotreba_L1 = states('sensor.ac_loads_L1') | float(0) %}
    {% set spotreba_L2 = states('sensor.ac_loads_L2') | float(0) %}
    {% set spotreba_L3 = states('sensor.ac_loads_L3') | float(0) %}
    {% set spotreba = spotreba_L1 + spotreba_L2 + spotreba_L3 %}
    {% set nabijeni_baterie = states('sensor.battery_power_plus') | float(0) %}
    {{ (vyroba - spotreba - nabijeni_baterie) | round(0) }}

- name: "FVE Dostupný přebytek"
  unique_id: fve_dostupny_prebytek
  icon: mdi:lightning-bolt
  unit_of_measurement: "W"
  device_class: power
  state: >
    {% set rozdil = states('sensor.fve_rozdil_vyroby_a_spotreby') | float(0) %}
    {{ [rozdil, 0] | max | round(0) }}

- name: "FVE Celková spotřeba AC"
  unique_id: fve_celkova_spotreba_ac
  icon: mdi:home-lightning-bolt
  unit_of_measurement: "W"
  device_class: power
  state: >
    {% set L1 = states('sensor.ac_loads_L1') | float(0) %}
    {% set L2 = states('sensor.ac_loads_L2') | float(0) %}
    {% set L3 = states('sensor.ac_loads_L3') | float(0) %}
    {{ (L1 + L2 + L3) | round(0) }}

- name: "FVE Celkový odběr ze sítě"
  unique_id: fve_celkovy_odber_ze_site
  icon: mdi:transmission-tower-import
  unit_of_measurement: "W"
  device_class: power
  state: >
    {% set L1 = states('sensor.grid_loads_L1') | float(0) %}
    {% set L2 = states('sensor.grid_loads_L2') | float(0) %}
    {% set L3 = states('sensor.grid_loads_L3') | float(0) %}
    {{ (L1 + L2 + L3) | round(0) }}

- name: "FVE Celkový prodej do sítě"
  unique_id: fve_celkovy_prodej_do_site
  icon: mdi:transmission-tower-export
  unit_of_measurement: "W"
  device_class: power
  state: >
    {% set L1 = states('sensor.grid_production_L1') | float(0) %}
    {% set L2 = states('sensor.grid_production_L2') | float(0) %}
    {% set L3 = states('sensor.grid_production_L3') | float(0) %}
    {{ (L1 + L2 + L3) | round(0) }}

- name: "FVE Energie v baterii"
  unique_id: fve_energie_v_baterii
  icon: mdi:battery
  unit_of_measurement: "kWh"
  device_class: energy
  state: >
    {% set soc = states('sensor.battery_percent') | float(0) %}
    {% set kapacita = states('input_number.fve_kapacita_baterie') | float(28) %}
    {{ (soc / 100 * kapacita) | round(2) }}

- name: "FVE Dostupná energie v baterii"
  unique_id: fve_dostupna_energie_v_baterii
  icon: mdi:battery-charging
  unit_of_measurement: "kWh"
  device_class: energy
  state: >
    {% set soc = states('sensor.battery_percent') | float(0) %}
    {% set min_soc = states('input_number.fve_min_soc') | float(20) %}
    {% set kapacita = states('input_number.fve_kapacita_baterie') | float(28) %}
    {% set hodnota = ((soc - min_soc) / 100) * kapacita %}
    {{ [hodnota, 0] | max | round(2) }}

- name: "FVE Volná kapacita baterie"
  unique_id: fve_volna_kapacita_baterie
  icon: mdi:battery-plus
  unit_of_measurement: "kWh"
  device_class: energy
  state: >
    {% set soc = states('sensor.battery_percent') | float(0) %}
    {% set kapacita = states('input_number.fve_kapacita_baterie') | float(28) %}
    {{ (((100 - soc) / 100) * kapacita) | round(2) }}

# Plán - čte data z command_line sensoru
- name: "FVE Plan"
  unique_id: fve_plan
  icon: mdi:calendar-clock
  state: "{{ states('sensor.fve_plan_data') | default('normal') }}"
  attributes:
    current_mode: "{{ state_attr('sensor.fve_plan_data', 'current_mode') | default('normal') }}"
    current_hour: "{{ state_attr('sensor.fve_plan_data', 'current_hour') | default(now().hour) }}"
    plan: "{{ state_attr('sensor.fve_plan_data', 'plan') | default([]) }}"
    last_update: "{{ state_attr('sensor.fve_plan_data', 'last_update') | default(now().isoformat()) }}"
