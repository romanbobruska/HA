[
    {
        "id": "ea6d31715793bece",
        "type": "tab",
        "label": "Automatizuj filtraci v bazénu",
        "disabled": false,
        "info": "Řízení filtrace bazénu podle sezóny, přebytku a SOC.\nRefaktorováno: 1 rozhodovací funkce místo 30+ nodes.",
        "env": []
    },
    {
        "id": "filtrace_grp_data",
        "type": "group",
        "z": "ea6d31715793bece",
        "name": "Sběr dat",
        "style": {
            "fill": "#e3f3d3",
            "label": true
        },
        "nodes": [
            "filtrace_st_state",
            "filtrace_st_letni",
            "filtrace_st_surplus",
            "filtrace_st_soc",
            "filtrace_st_auto",
            "filtrace_st_flag"
        ],
        "x": 274,
        "y": 119,
        "w": 602,
        "h": 182
    },
    {
        "id": "filtrace_grp_logic",
        "type": "group",
        "z": "ea6d31715793bece",
        "name": "Rozhodování",
        "style": {
            "fill": "#fff2cc",
            "label": true
        },
        "nodes": [
            "filtrace_decision"
        ],
        "x": 474,
        "y": 344,
        "w": 232,
        "h": 112
    },
    {
        "id": "filtrace_grp_actions",
        "type": "group",
        "z": "ea6d31715793bece",
        "name": "Akce",
        "style": {
            "fill": "#ffbfbf",
            "label": true
        },
        "nodes": [
            "filtrace_act_on",
            "filtrace_act_off",
            "filtrace_flag_on",
            "filtrace_flag_off"
        ],
        "x": 364,
        "y": 499,
        "w": 452,
        "h": 182
    },
    {
        "id": "e840eaa72d311da7",
        "type": "inject",
        "z": "ea6d31715793bece",
        "name": "2 minuty",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "120",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 100,
        "y": 60,
        "wires": [
            [
                "filtrace_auto_check"
            ]
        ]
    },
    {
        "id": "filtrace_auto_check",
        "type": "api-current-state",
        "z": "ea6d31715793bece",
        "name": "Automatizovat filtraci?",
        "server": "c7421fe2.cb11c",
        "version": 3,
        "outputs": 2,
        "halt_if": "on",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.automatizovat_filtraci_v_bazenu",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 300,
        "y": 60,
        "wires": [
            [
                "filtrace_st_state"
            ],
            []
        ]
    },
    {
        "id": "filtrace_st_state",
        "type": "api-current-state",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_data",
        "name": "Stav filtrace",
        "server": "c7421fe2.cb11c",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "switch.filtrace",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "filtraceState",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 160,
        "wires": [
            [
                "filtrace_st_letni"
            ]
        ]
    },
    {
        "id": "filtrace_st_letni",
        "type": "api-current-state",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_data",
        "name": "Letní režim",
        "server": "c7421fe2.cb11c",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.letni_rezim",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "letniRezim",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 160,
        "wires": [
            [
                "filtrace_st_surplus"
            ]
        ]
    },
    {
        "id": "filtrace_st_surplus",
        "type": "api-current-state",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_data",
        "name": "Přebytek výroby",
        "server": "c7421fe2.cb11c",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.rozdil_vyroby_a_spotreby",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "solarSurplus",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 160,
        "wires": [
            [
                "filtrace_st_soc"
            ]
        ]
    },
    {
        "id": "filtrace_st_soc",
        "type": "api-current-state",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_data",
        "name": "SOC baterie",
        "server": "c7421fe2.cb11c",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.battery_percent",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "batterySoc",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 260,
        "wires": [
            [
                "filtrace_st_auto"
            ]
        ]
    },
    {
        "id": "filtrace_st_auto",
        "type": "api-current-state",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_data",
        "name": "Auto má hlad?",
        "server": "c7421fe2.cb11c",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.auto_ma_hlad",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "autoMaHlad",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 260,
        "wires": [
            [
                "filtrace_st_flag"
            ]
        ]
    },
    {
        "id": "filtrace_st_flag",
        "type": "api-current-state",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_data",
        "name": "Spuštěna dříve?",
        "server": "c7421fe2.cb11c",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.filtrace_spustena_drive",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "filtraceSpustenaDrive",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 260,
        "wires": [
            [
                "filtrace_decision"
            ]
        ]
    },
    {
        "id": "filtrace_decision",
        "type": "function",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_logic",
        "name": "Rozhodnutí filtrace",
        "func": "// Filtrace bazénu - Rozhodovací logika\n// =====================================\n// LÉTO - Zapnutí:\n//   8:00 + přebytek > 3kW → ON (early start, flag ON)\n//   9:00 → ON (normal start, flag OFF)\n//   16:00 + auto nemá hlad + (SOC≥85% + přebytek>3kW NEBO SOC≥94%) → ON\n// LÉTO - Vypnutí:\n//   Early start → OFF v 11:00\n//   Normal start → OFF v 12:00\n//   18:00 → OFF pokud SOC<85% nebo přebytek<2kW\n//   19:00 → OFF (hard deadline)\n// ZIMA:\n//   02:00 → ON, 03:00 → OFF (1h filtrace)\n\nvar filtraceOn = (msg.filtraceState === \"on\");\nvar letniRezim = (msg.letniRezim === \"on\");\nvar solarSurplus = parseFloat(msg.solarSurplus) || 0;\nvar batterySoc = parseFloat(msg.batterySoc) || 0;\nvar autoMaHlad = (msg.autoMaHlad === \"on\");\nvar spustenaDrive = (msg.filtraceSpustenaDrive === \"on\");\n\n// Timezone-safe (Europe/Prague)\nvar timeParts = new Date().toLocaleTimeString('en-GB', {timeZone: 'Europe/Prague', hour12: false}).split(':');\nvar hour = parseInt(timeParts[0]);\nvar min = parseInt(timeParts[1]);\n\n// Prahy\nvar SOLAR_ON = 3000;      // W přebytek pro zapnutí\nvar SOLAR_OFF = 2000;     // W přebytek pro vypnutí\nvar SOC_HIGH = 85;        // % baterie\nvar SOC_VERY_HIGH = 94;   // % baterie téměř plná\n\n// Časová okna (odpovídají původním time-range-switch)\nfunction inWindow(h1, m1, h2, m2) {\n    var nowM = hour * 60 + min;\n    return nowM >= (h1 * 60 + m1) && nowM <= (h2 * 60 + m2);\n}\n\nvar action = \"none\";\nvar reason = \"\";\n\nif (!filtraceOn) {\n    // === FILTRACE VYPNUTA - zapnout? ===\n    if (letniRezim) {\n        if (inWindow(7,59,8,15) && solarSurplus > SOLAR_ON) {\n            action = \"on_early\";\n            reason = \"8:00 + přebytek \" + Math.round(solarSurplus) + \"W\";\n        } else if (inWindow(8,59,9,15)) {\n            action = \"on_normal\";\n            reason = \"9:00 - povinný start\";\n        } else if (inWindow(15,59,16,15) && !autoMaHlad) {\n            if (batterySoc >= SOC_HIGH && solarSurplus > SOLAR_ON) {\n                action = \"on\";\n                reason = \"16:00 SOC:\" + batterySoc + \"% přebytek:\" + Math.round(solarSurplus) + \"W\";\n            } else if (batterySoc >= SOC_VERY_HIGH) {\n                action = \"on\";\n                reason = \"16:00 SOC:\" + batterySoc + \"% >= \" + SOC_VERY_HIGH + \"%\";\n            }\n        }\n    } else {\n        if (inWindow(1,59,2,3)) {\n            action = \"on\";\n            reason = \"02:00 - zimní filtrace\";\n        }\n    }\n} else {\n    // === FILTRACE ZAPNUTA - vypnout? ===\n    if (letniRezim) {\n        if (spustenaDrive && inWindow(10,59,11,15)) {\n            action = \"off\";\n            reason = \"11:00 - konec filtrace (early)\";\n        } else if (!spustenaDrive && inWindow(11,59,12,15)) {\n            action = \"off\";\n            reason = \"12:00 - konec filtrace (normal)\";\n        }\n        if (action === \"none\") {\n            if (inWindow(17,59,18,15)) {\n                if (batterySoc < SOC_HIGH) {\n                    action = \"off\";\n                    reason = \"18:00 SOC:\" + batterySoc + \"% < \" + SOC_HIGH + \"%\";\n                } else if (solarSurplus < SOLAR_OFF) {\n                    action = \"off\";\n                    reason = \"18:00 přebytek:\" + Math.round(solarSurplus) + \"W < \" + SOLAR_OFF + \"W\";\n                }\n            } else if (inWindow(18,59,19,15)) {\n                action = \"off\";\n                reason = \"19:00 - hard deadline\";\n            }\n        }\n    } else {\n        if (inWindow(2,59,3,5)) {\n            action = \"off\";\n            reason = \"03:00 - konec zimní filtrace\";\n        }\n    }\n}\n\n// Status\nvar st = (letniRezim ? \"LÉTO\" : \"ZIMA\");\nst += \" | \" + (filtraceOn ? \"ON\" : \"OFF\");\nst += \" | SOC:\" + batterySoc + \"% | ΔP:\" + Math.round(solarSurplus) + \"W\";\nif (spustenaDrive) st += \" | EARLY\";\nif (action !== \"none\") st += \" → \" + action + \": \" + reason;\nvar c = {on_early:\"blue\", on_normal:\"blue\", on:\"blue\", off:\"yellow\", none:\"green\"};\nnode.status({fill: c[action] || \"green\", shape: \"dot\", text: st});\n\n// Výstupy: [Filtrace ON, Filtrace OFF, Flag ON, Flag OFF]\nvar out = [null, null, null, null];\nif (action === \"on_early\" || action === \"on_normal\" || action === \"on\") {\n    out[0] = {payload: action, reason: reason};\n}\nif (action === \"off\") {\n    out[1] = {payload: \"off\", reason: reason};\n}\nif (action === \"on_early\") {\n    out[2] = {payload: \"on\"};\n}\nif (action === \"on_normal\") {\n    out[3] = {payload: \"off\"};\n}\nreturn out;",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 400,
        "wires": [
            [
                "filtrace_act_on"
            ],
            [
                "filtrace_act_off"
            ],
            [
                "filtrace_flag_on"
            ],
            [
                "filtrace_flag_off"
            ]
        ]
    },
    {
        "id": "filtrace_act_on",
        "type": "api-call-service",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_actions",
        "name": "Filtrace ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.filtrace"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "switch",
        "service": "turn_on",
        "x": 490,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "filtrace_act_off",
        "type": "api-call-service",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_actions",
        "name": "Filtrace OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.filtrace"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "switch",
        "service": "turn_off",
        "x": 690,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "filtrace_flag_on",
        "type": "api-call-service",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_actions",
        "name": "Spuštěna dříve = ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.filtrace_spustena_drive"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "switch",
        "service": "turn_on",
        "x": 490,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "filtrace_flag_off",
        "type": "api-call-service",
        "z": "ea6d31715793bece",
        "g": "filtrace_grp_actions",
        "name": "Spuštěna dříve = OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.filtrace_spustena_drive"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "switch",
        "service": "turn_off",
        "x": 690,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "c7421fe2.cb11c",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "46f74c8e57a22280",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3"
        }
    }
]