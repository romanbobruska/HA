[
    {
        "id": "f1e2d3c4b5a60001",
        "type": "tab",
        "label": "FVE Heating",
        "disabled": false,
        "info": "Kompletní řízení topení domu v2.0\nNIBE + oběhové čerpadlo + patrony + ventil + chlazení"
    },
    {
        "id": "heating_g_main_v2",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Řízení topení",
        "style": {
            "label": true,
            "fill": "#ffffbf"
        },
        "nodes": [
            "htg_inject_60s",
            "htg_trig_auto",
            "htg_trig_temp",
            "htg_main_func",
            "htg_debug"
        ],
        "x": 14,
        "y": 18,
        "w": 732,
        "h": 202
    },
    {
        "id": "heating_g_exec_v2",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Exekuce akcí",
        "style": {
            "label": true,
            "fill": "#ffbfbf"
        },
        "nodes": [
            "htg_action_switch",
            "htg_svc_nibe_on",
            "htg_svc_nibe_off",
            "htg_svc_obehove_on",
            "htg_svc_obehove_off",
            "htg_svc_p1_on",
            "htg_svc_p1_off",
            "htg_svc_p2_on",
            "htg_svc_p2_off",
            "htg_svc_p3_on",
            "htg_svc_p3_off",
            "htg_svc_ventil_off",
            "htg_svc_cool_on",
            "htg_svc_cool_off"
        ],
        "x": 14,
        "y": 339,
        "w": 436,
        "h": 674
    },
    {
        "id": "f1e2d3c4b5a60004",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Ochrana baterie",
        "style": {
            "label": true
        },
        "nodes": [
            "htg_prot_trig",
            "htg_prot_func",
            "htg_prot_set"
        ],
        "x": 14,
        "y": 1039,
        "w": 682,
        "h": 82
    },
    {
        "id": "heating_g_away",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Režim nepřítomnosti",
        "style": {
            "stroke": "#ff9900",
            "label": true,
            "color": "#ff9900"
        },
        "nodes": [
            "htg_away_trigger",
            "htg_away_func",
            "htg_away_set_temp"
        ],
        "x": 14,
        "y": 1339,
        "w": 662,
        "h": 82
    },
    {
        "id": "htg_g_pat_korekce",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Patrony korekce vybíjení (5s)",
        "style": {
            "stroke": "#ff7f0e",
            "stroke-opacity": "1",
            "fill": "#fff3e6",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#ff7f0e"
        },
        "nodes": [
            "pat_korekce_inject",
            "pat_korekce_func",
            "pat_korekce_router"
        ],
        "x": 14,
        "y": 231.5,
        "w": 852,
        "h": 97
    },
    {
        "id": "htg_g_topeni_mod",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Topení MOD → HA sync",
        "style": {
            "stroke": "#1f77b4",
            "stroke-opacity": "1",
            "fill": "#e8f4fd",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#1f77b4"
        },
        "nodes": [
            "htg_topeni_mod_change",
            "htg_topeni_mod_api"
        ],
        "x": 14,
        "y": 1139,
        "w": 442,
        "h": 82
    },
    {
        "id": "htg_g_reload",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Inicializace (startup)",
        "style": {
            "stroke": "#2ca02c",
            "stroke-opacity": "1",
            "fill": "#e8f8e8",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#2ca02c"
        },
        "nodes": [
            "htg_reload_input_select_inject",
            "htg_reload_input_select_api"
        ],
        "x": 14,
        "y": 1239,
        "w": 502,
        "h": 82
    },
    {
        "id": "htg_inject_60s",
        "type": "inject",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Každých 60s",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "timer",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 59,
        "wires": [
            [
                "htg_main_func"
            ]
        ]
    },
    {
        "id": "htg_trig_auto",
        "type": "server-state-changed",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Automatizace změna",
        "server": "c7421fe2.cb11c",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.automatizovat_topeni"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 160,
        "y": 119,
        "wires": [
            [
                "htg_main_func"
            ]
        ]
    },
    {
        "id": "htg_trig_temp",
        "type": "server-state-changed",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Teplota změna",
        "server": "c7421fe2.cb11c",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.hp2551ae_pro_v2_1_0_indoor_temperature"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 160,
        "y": 179,
        "wires": [
            [
                "htg_main_func"
            ]
        ]
    },
    {
        "id": "htg_main_func",
        "type": "function",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Řízení topení v2.0",
        "func": "// FVE Heating Control v2.0 — Kompletní řízení topení domu\n// Řídí: NIBE (47371), oběhové čerpadlo, patrony (3 fáze), bazénový ventil, chlazení\n\nvar config = global.get(\"fve_config\") || {};\nvar prices = global.get(\"fve_prices_forecast\") || [];\n\n// === HELPER ===\nfunction getState(id) {\n    var e = global.get(\"homeassistant.homeAssistant.states['\" + id + \"']\") || {};\n    return e.state;\n}\nfunction getFloat(id, def) {\n    var v = parseFloat(getState(id));\n    return isNaN(v) ? (def || 0) : v;\n}\nfunction getBool(id) { return getState(id) === \"on\"; }\n\n// Najdi nejlevnější budoucí hodinu (do konce solární výroby nebo do rána)\nfunction hasCheaperHourAhead(prices, currentHour, currentLevel) {\n    for (var i = 0; i < prices.length; i++) {\n        var h = prices[i].hour;\n        var m = prices[i].minute || 0;\n        if (m !== 0) continue;\n        // Budoucí hodiny (po aktuální)\n        if (h <= currentHour) continue;\n        var futureLevel = prices[i].levelCheapestHourBuy || 99;\n        if (futureLevel < currentLevel) return true;\n    }\n    return false;\n}\n\n// === PARAMETRY Z CONFIGU ===\nvar MIN_TANK = config.topeni_min_teplota_nadrze || 30;\nvar MAX_TANK = config.topeni_max_teplota_nadrze || 50;\nvar NOCNI_SNIZ = config.topeni_nocni_snizeni || 0.5;\nvar NOCNI_OD = config.topeni_nocni_od || 22;\nvar NOCNI_DO = config.topeni_nocni_do || 6;\nvar NOUZ_TEMP = config.topeni_nouzova_teplota || 18;\nvar MIN_PRETOK = config.topeni_min_pretok_patron_w || 3000;\nvar PATRON_W = config.topeni_patron_faze_w || 3000;\nvar MIN_SOC_PAT = config.topeni_min_soc_patron || 95;\nvar MAX_TANK_PAT = config.topeni_max_teplota_patron || 50;\nvar PRAH_DRAHA = config.prah_draha_energie || 12;\nvar BEZPECNY_POKLES = config.topeni_bezpecny_pokles || 0.7;\nvar HYSTEREZE_CHLAZENI = config.topeni_hystereze_chlazeni || 1.0;\nvar SOLAR_FORECAST_THRESHOLD = config.topeni_solar_forecast_kwh || 30;\nvar solarForecastTomorrow = getFloat(\"input_number.predpoved_solarni_vyroby_zitra\", 0);\nvar bigSolarTomorrow = solarForecastTomorrow >= SOLAR_FORECAST_THRESHOLD;\nvar letniRezim = config.letni_rezim === true;\n\n// === ČTENÍ STAVŮ ===\nvar automatizace = getBool(\"input_boolean.automatizovat_topeni\");\nvar targetTemp = getFloat(\"input_number.nastavena_teplota_v_dome\", 22);\nvar indoorTemp = getFloat(\"sensor.hp2551ae_pro_v2_1_0_indoor_temperature\", 20);\nvar outdoorTemp = getFloat(\"sensor.hp2551ae_pro_v2_1_0_outdoor_temperature\", 10);\nvar tankTemp = getFloat(\"sensor.teplota_smesovac_teplota\", 35);\nvar dm = getFloat(\"sensor.nibe_degree_minutes\", 0);\nvar batSoc = getFloat(\"sensor.battery_percent\", 50);\nvar prebytek = getFloat(\"sensor.fve_dostupny_prebytek\", 0);\nvar compressor = getBool(\"binary_sensor.nibe_kompresory_aktivni_binarni\");\nvar pumpState = getState(\"sensor.nibe_aktualni_realny_stav\") || \"\";\nvar fireplace = getBool(\"input_boolean.topi_se_v_krbu\");\nvar coolEnabled = getBool(\"input_boolean.chlazeni\");\nvar autoHlad = getBool(\"input_boolean.auto_ma_hlad\");\nvar autoNabiji = global.get(\"auto_nabijeni_aktivni\") || false;  // wallbox fyzicky nabiji\n\nvar nibeOn = getBool(\"switch.nibe_topeni\");\nvar obehOn = getBool(\"switch.horousany_termostat_prizemi_kote\");\nvar p1on = getBool(\"switch.patrona_faze_1\");\nvar p2on = getBool(\"switch.patrona_faze_3_2\");\nvar p3on = getBool(\"switch.patrona_faze_3\");\nvar ventilOn = getBool(\"switch.bazen_ventil_smesovac\");\nvar coolOn = getBool(\"switch.nibe_chlazeni\");\n\nvar hour = new Date().getHours();\nvar now = Date.now();\nvar NIBE_COOLDOWN_MS = (config.nibe_cooldown_min || 10) * 60 * 1000;  // min doba mezi NIBE přepnutími\nvar lastNibeSwitch = flow.get(\"last_nibe_switch\") || 0;\nvar nibeCooldownOk = (now - lastNibeSwitch) >= NIBE_COOLDOWN_MS;\n\n// === GRID LOST ===\nvar gridLostRaw = getFloat(\"sensor.grid_lost_ciselny\", 0);\nvar gridLost = gridLostRaw >= 2;  // 0=OK, 1=Warning, 2=Grid Lost\nvar solarPower = getFloat(\"sensor.vyroba_fve\", 0);  // aktuální solární výkon (W)\nvar NIBE_PEAK_W = config.nibe_peak_w || 14000;  // peak odběr NIBE\n\n// === SOLÁRNÍ HODINY ===\nvar plan = global.get(\"fve_plan\") || {};\nvar solarStart = (plan && plan.solarStartHour) || 9;\nvar solarEnd = (plan && plan.solarEndHour) || 17;\nvar isSolarHour = (hour >= solarStart && hour < solarEnd);\nvar solarHoursLeft = isSolarHour ? (solarEnd - hour) : 0;\nvar SOLAR_MARGIN_HOURS = config.topeni_solar_margin_hours || 2;\n\n// === CENOVÝ LEVEL (vždy celá hodina, minute=0) ===\nvar lvl = 99;\nfor (var i = 0; i < prices.length; i++) {\n    if (prices[i].hour === hour && (prices[i].minute === 0 || prices[i].minute === undefined)) {\n        lvl = prices[i].levelCheapestHourBuy || 99;\n        break;\n    }\n}\nvar isDraha = lvl >= PRAH_DRAHA;\n\n// === NOČNÍ REŽIM ===\nvar isNight = (hour >= NOCNI_OD || hour < NOCNI_DO);\n// Noční snížení = hystereze pro drahé hodiny (v levných topit na plnou teplotu)\nvar effTarget = (isNight && isDraha) ? (targetTemp - NOCNI_SNIZ) : targetTemp;\n\n// === PATRONY STATE ===\nvar actPat = (p1on ? 1 : 0) + (p2on ? 1 : 0) + (p3on ? 1 : 0);\nvar availPat = prebytek + actPat * PATRON_W;\n\n// === OCHRANA ===\nvar pumpWorking = pumpState.indexOf(\"Klidový\") === -1 && pumpState !== \"\";\nvar canOffNibe = !compressor && !pumpWorking;\nvar canOnNibe = nibeCooldownOk;\n\n// === ROZHODOVÁNÍ ===\nvar actions = [];\nvar reason = \"\";\nvar patTarget = 0;\nvar shutdownDone = flow.get(\"shutdown_done\") || false;\n\nif (!automatizace) {\n    // AUTOMATIZACE OFF — manuální mód dle input_select.topeni_mod\n    // Flow NEPŘEPISUJE mod — jen provádí příkazy dle manuálně nastavenémo modu\n    var manualMod = getState(\"input_select.topeni_mod\") || \"Vypnuto\";\n    flow.set(\"topeni_mod_active\", manualMod);  // sync flow state s HA entitou\n\n    if (manualMod === \"Vypnuto\") {\n        // Manuální VYPNUTO — žádné zásahy, uživatel ovládá vše sám\n        reason = \"Manuální mod: VYPNUTO — bez zásahů automatizace\";\n\n    } else if (manualMod === \"NIBE\") {\n        // Manuální NIBE — topit jen z NIBE dle standardních pravidel, patrony blok\n        if (obehOn) actions.push(\"obehove_off\");\n        if (p1on) actions.push(\"p1_off\");\n        if (p2on) actions.push(\"p2_off\");\n        if (p3on) actions.push(\"p3_off\");\n        var tankOk = tankTemp >= MIN_TANK;\n        var needsHeat = indoorTemp < effTarget;\n        if (needsHeat && !nibeOn && canOnNibe) {\n            actions.push(\"nibe_on\");\n            reason = \"Manuální mod: NIBE — topení ON\";\n        } else if (!needsHeat && nibeOn && canOffNibe) {\n            actions.push(\"nibe_off\");\n            reason = \"Manuální mod: NIBE — teplota OK, topení OFF\";\n        } else {\n            reason = \"Manuální mod: NIBE | \" + indoorTemp.toFixed(1) + \"/\" + effTarget.toFixed(1) + \"°C\";\n        }\n\n    } else if (manualMod === \"Patrony\") {\n        // Manuální PATRONY — topit jen z patron, NIBE blokováno\n        if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        if (obehOn) actions.push(\"obehove_off\");\n        var tankOk = tankTemp >= MIN_TANK;\n        var patronyMohou = batSoc >= MIN_SOC_PAT && !autoHlad && !autoNabiji && tankTemp < MAX_TANK_PAT && (!gridLost || solarPower > 0);\n        // Hlavní loop zapíná patrony POUZE pokud actPat === 0.\n        // Pokud patrony běží (actPat > 0), 5s smyčka řídí počet fází.\n        if (patronyMohou && actPat === 0) {\n            if (availPat >= MIN_PRETOK * 3)      { patTarget = 3; }\n            else if (availPat >= MIN_PRETOK * 2) { patTarget = 2; }\n            else if (availPat >= MIN_PRETOK)     { patTarget = 1; }\n        } else if (patronyMohou && actPat > 0) {\n            // Patrony běží — 5s smyčka řídí\n            patTarget = actPat;\n        }\n        // patronyMohou === false → hlavní loop vypne fáze\n        var p1want = patTarget >= 1;\n        var p2want = patTarget >= 2;\n        var p3want = patTarget >= 3;\n        if (p1want !== p1on) actions.push(p1want ? \"p1_on\" : \"p1_off\");\n        if (p2want !== p2on) actions.push(p2want ? \"p2_on\" : \"p2_off\");\n        if (p3want !== p3on) actions.push(p3want ? \"p3_on\" : \"p3_off\");\n        reason = \"Manuální mod: PATRONY | přebytek=\" + Math.round(availPat) + \"W fáze=\" + patTarget;\n\n    } else if (manualMod === \"Obehove\") {\n        // Manuální OBĚHOVÉ — jen oběhové čerpadlo, vše ostatní off\n        if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        if (p1on) actions.push(\"p1_off\");\n        if (p2on) actions.push(\"p2_off\");\n        if (p3on) actions.push(\"p3_off\");\n        var tankOk = tankTemp >= MIN_TANK;\n        var needsHeat = indoorTemp < effTarget;\n        if (tankOk && needsHeat && !obehOn) {\n            actions.push(\"obehove_on\");\n            reason = \"Manuální mod: OBĚHOVÉ — ON\";\n        } else if ((!tankOk || !needsHeat) && obehOn) {\n            actions.push(\"obehove_off\");\n            reason = \"Manuální mod: OBĚHOVÉ — OFF\";\n        } else {\n            reason = \"Manuální mod: OBĚHOVÉ | nádrž=\" + tankTemp.toFixed(1) + \"°C\";\n        }\n    }\n\n    // Zapiš aktuální manuální mod do global (pro HA input_select update)\n    global.set(\"topeni_mod\", manualMod);\n\n} else {\n    var forceStart = flow.get(\"shutdown_done\") === true;  // právě zapnuta automatizace\n    flow.set(\"shutdown_done\", false);\n    // Reset summer flag pokud se změní automatizace\n    if (letniRezim) {\n        // LETNÍ REŽIM — jednorázové nastavení default stavu, pak jen chlazení\n        var summerDone = flow.get(\"summer_setup_done\") || false;\n        if (!summerDone) {\n            // Jednorázově: NIBE on (pro TUV), oběhové off, patrony off\n            if (canOffNibe) actions.push(\"nibe_on\");\n            if (obehOn) actions.push(\"obehove_off\");\n            if (p1on) actions.push(\"p1_off\");\n            if (p2on) actions.push(\"p2_off\");\n            if (p3on) actions.push(\"p3_off\");\n            flow.set(\"summer_setup_done\", true);\n            reason = \"Léto — jednorázové nastavení default\";\n        }\n\n        // Chlazení — běží stále v létě\n        if (coolEnabled) {\n            if (!coolOn && indoorTemp > effTarget + HYSTEREZE_CHLAZENI) {\n                actions.push(\"cool_on\");\n                reason = \"Chlazení ON (\" + indoorTemp.toFixed(1) + \">\" + (effTarget+HYSTEREZE_CHLAZENI).toFixed(1) + \"°C)\";\n            } else if (coolOn && indoorTemp < effTarget) {\n                actions.push(\"cool_off\");\n                reason = \"Chlazení OFF (\" + indoorTemp.toFixed(1) + \"<\" + effTarget.toFixed(1) + \"°C)\";\n            } else {\n                reason = \"Léto | \" + indoorTemp.toFixed(1) + \"/\" + effTarget.toFixed(1) + \"°C\" + (coolOn ? \" | Chlazení\" : \"\");\n            }\n        } else {\n            if (coolOn) actions.push(\"cool_off\");\n            reason = \"Léto | chlazení vypnuto\";\n        }\n    } else {\n        // ZIMNÍ REŽIM\n        flow.set(\"summer_setup_done\", false);\n\n        // 1. Bazénový ventil - kontrola\n        if (ventilOn) actions.push(\"ventil_off\");\n\n        // 2. Chlazení OFF v zimě\n        if (coolOn) actions.push(\"cool_off\");\n\n        // 3. TOPÉNÍ MOD — vzájemná exkluzivita NIBE a patrony\n        // MOD_PATRONY → NIBE blokováno. MOD_NIBE → patrony blokovány.\n        var topeniModAktivni = flow.get(\"topeni_mod_active\") || \"Vypnuto\";\n\n        // Podmínky pro topení\n        var tankOk = tankTemp >= MIN_TANK;\n        var needsHeat = indoorTemp < effTarget;\n\n        // Podmínky pro spuštění patrony (solární přebytek)\n        var patronyMohou = batSoc >= MIN_SOC_PAT && !autoHlad && !autoNabiji && tankTemp < MAX_TANK_PAT && (!gridLost || solarPower > 0);\n        var patronyActive = false;\n        // Hlavní loop zapíná patrony POUZE pokud actPat === 0 (první zapnutí nebo restart).\n        // Jakmile patrony jednou běží, 5s smyčka (pat_korekce_func) přebírá řízení počtu fází.\n        if (patronyMohou && actPat === 0) {\n            // Patrony neběží — hlavní loop rozhodne kolik fází zapnout dle přebytku\n            if (availPat >= MIN_PRETOK * 3)      { patTarget = 3; patronyActive = true; }\n            else if (availPat >= MIN_PRETOK * 2) { patTarget = 2; patronyActive = true; }\n            else if (availPat >= MIN_PRETOK)     { patTarget = 1; patronyActive = true; }\n        } else if (patronyMohou && actPat > 0) {\n            // Patrony běží — 5s smyčka řídí, hlavní loop jen zaznamená stav\n            patTarget = actPat;\n            patronyActive = true;\n        }\n        // patronyMohou === false → hlavní loop vypne fáze (podmínky nesplněny)\n\n        // Přepínání modu (patrony mají přednost před NIBE)\n        if (patronyActive) {\n            topeniModAktivni = \"Patrony\";\n        } else if (topeniModAktivni === \"Patrony\") {\n            // Patrony skončily → přepni na NIBE nebo Vypnuto\n            topeniModAktivni = needsHeat ? \"NIBE\" : \"Vypnuto\";\n        } else if (needsHeat && topeniModAktivni === \"Vypnuto\") {\n            topeniModAktivni = \"NIBE\";\n        } else if (!needsHeat && topeniModAktivni === \"NIBE\") {\n            topeniModAktivni = \"Vypnuto\";\n        }\n        flow.set(\"topeni_mod_active\", topeniModAktivni);\n\n        // Blokace dle modu\n        var nibeBlockedByMod     = (topeniModAktivni === \"Patrony\");\n        var patronyBlockedByMod  = (topeniModAktivni === \"NIBE\");\n\n        // Patrony ON/OFF (blokované pokud MOD_NIBE)\n        var p1want = !patronyBlockedByMod && patTarget >= 1;\n        var p2want = !patronyBlockedByMod && patTarget >= 2;\n        var p3want = !patronyBlockedByMod && patTarget >= 3;\n        if (p1want !== p1on) actions.push(p1want ? \"p1_on\" : \"p1_off\");\n        if (p2want !== p2on) actions.push(p2want ? \"p2_on\" : \"p2_off\");\n        if (p3want !== p3on) actions.push(p3want ? \"p3_on\" : \"p3_off\");\n\n        // 4. NIBE řízení (blokováno pokud MOD_PATRONY)\n        var nibeBlockedByPatrony = nibeBlockedByMod;\n        var nibeBlockDischarge = true;\n        var safeTemp = effTarget - BEZPECNY_POKLES;  // bezpečný práh: effTarget - 0.7°C (v noci nižší díky NOCNI_SNIZ)\n        var cheaperAhead = hasCheaperHourAhead(prices, hour, lvl);\n        \n        // Grid Lost ochrana — NIBE jen pokud solár stačí na peak\n        var gridAllowNibe = !gridLost || (gridLost && solarPower >= NIBE_PEAK_W);\n        if (!gridAllowNibe) {\n            // Grid Lost + nedostatek soláru → NIBE OFF\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        } else if (fireplace) {\n            // Krb aktivní → NIBE OFF (krb nahřívá nádrž místo NIBE)\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        } else if (tankTemp > MAX_TANK) {\n            // Nádrž přehřátá (> MAX_TANK) → NIBE OFF\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        } else if (nibeBlockedByPatrony) {\n            // Patrony aktivní nebo fyzicky zapnuté → NIBE OFF + zablokovat nibe_on (bezpečnost jističe)\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        } else if (isSolarHour && indoorTemp >= effTarget && solarHoursLeft > SOLAR_MARGIN_HOURS) {\n            // Solární hodiny + teplota OK + dost času → NIBE OFF, čekáme na patrony\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        } else if (isSolarHour && solarHoursLeft <= SOLAR_MARGIN_HOURS && needsHeat) {\n            // Poslední solární hodiny + potřeba topit → NIBE ON\n            if (prebytek >= MIN_PRETOK) {\n                // Velký solární zisk → BEZ blokace vybíjení\n                if (!nibeOn) actions.push(\"nibe_on\");\n                nibeBlockDischarge = false;\n            } else {\n                if (!isDraha) {\n                    if (!nibeOn) actions.push(\"nibe_on\");\n                } else if (indoorTemp < safeTemp) {\n                    if (!nibeOn) actions.push(\"nibe_on\");\n                } else {\n                    if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n                }\n            }\n        } else if (isDraha) {\n            // DRAHÁ HODINA: topit JEN pokud teplota pod bezpečným prahem\n            if (indoorTemp < safeTemp) {\n                if (!nibeOn) actions.push(\"nibe_on\");\n            } else {\n                if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n            }\n        } else if (needsHeat) {\n            // Levné/střední hodiny + potřeba topit\n            // v2.1: Při velkém solárním forecastu šetříme energii\n            // → topíme jen pokud teplota klesne pod bezpečný práh (safeTemp)\n            if (bigSolarTomorrow && indoorTemp >= safeTemp) {\n                // Velký solar zítra + teplota bezpečná → NIBE OFF, šetříme\n                if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n            } else if (cheaperAhead && indoorTemp >= safeTemp) {\n                // Teplota bezpečná + levnější hodiny existují → POČKAT\n                if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n            } else {\n                // Potřeba topit a nemá smysl čekat (nebo teplota pod safeTemp)\n                if (!nibeOn) actions.push(\"nibe_on\");\n            }\n        } else {\n            // Nepotřebuje topit → NIBE OFF\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        }\n\n        // Uložit info o blokaci vybíjení pro NIBE\n        flow.set(\"nibe_block_discharge\", nibeBlockDischarge);\n        \n        // 5. Oběhové čerpadlo (při krbu NESAHAT - řídí jiná automatika)\n        // Oběhové je nezávislé na NIBE — čerpá teplo z nádrže do domu kdykoli nádrž má co dát\n        // bigSolarTomorrow omezení se týká jen NIBE, ne oběhového (oběhové spotřebuje minimum)\n        if (!fireplace) {\n            // Noční snížení: oběhové nespouštět pokud teplota neklesla pod targetTemp - NOCNI_SNIZ\n            var obehoveTarget = isNight ? (targetTemp - NOCNI_SNIZ) : effTarget;\n            var needsHeatObehove = indoorTemp < obehoveTarget;\n            if (tankOk && needsHeatObehove) {\n                actions.push(\"obehove_on\");\n            } else {\n                // Nádrž vychladlá nebo teplota v noci OK → čerpadlo off\n                if (obehOn) actions.push(\"obehove_off\");\n            }\n        }\n\n        // Reason\n        var parts = [];\n        parts.push(isDraha ? \"DRAHÁ(Lv\" + lvl + \")\" : \"Lv\" + lvl);\n        parts.push(\"In:\" + indoorTemp.toFixed(1) + \"/\" + effTarget.toFixed(1) + \"°C\");\n        parts.push(\"Tank:\" + tankTemp.toFixed(0) + \"°C\");\n        parts.push(\"DM:\" + Math.round(dm));\n        parts.push(\"Out:\" + outdoorTemp.toFixed(0) + \"°C\");\n        if (patronyActive) parts.push(\"PAT:\" + patTarget + \"f(\" + Math.round(availPat) + \"W)\");\n        if (fireplace) parts.push(\"KRB\");\n        if (isNight) parts.push(\"NOC\");\n        if (gridLost) parts.push(\"⚡GRID_LOST\");\n        if (isSolarHour) parts.push(\"☀\" + solarHoursLeft + \"h\");\n        if (cheaperAhead) parts.push(\"LEVNĚJŠÍ↓\");\n        if (bigSolarTomorrow) parts.push(\"☀Z:\" + Math.round(solarForecastTomorrow) + \"kWh\");\n        parts.push(\"Safe:\" + safeTemp.toFixed(1) + \"°C\");\n        if (!nibeBlockDischarge) parts.push(\"NoBLK\");\n        reason = parts.join(\" | \");\n    }\n}\n\n// === OCHRANA: NIBE nelze vypnout pokud pracuje ===\nif (actions.indexOf(\"nibe_off\") > -1 && !canOffNibe) {\n    actions = actions.filter(function(a) { return a !== \"nibe_off\"; });\n    reason += \" ⚠️OCHRANA:NIBE pracuje\";\n}\n\n// === OCHRANA: nikdy nibe_on + nibe_off zároveň ===\nvar hasNibeOn = actions.indexOf(\"nibe_on\") > -1;\nvar hasNibeOff = actions.indexOf(\"nibe_off\") > -1;\nif (hasNibeOn && hasNibeOff) {\n    // Konflikt — ponechat aktuální stav (nic nedělat)\n    actions = actions.filter(function(a) { return a !== \"nibe_on\" && a !== \"nibe_off\"; });\n    reason += \" ⚠️KONFLIKT:on+off→skip\";\n}\n\n// === COOLDOWN: min doba mezi NIBE přepnutími (přeskočit při forceStart) ===\nif ((hasNibeOn && !nibeOn) || (hasNibeOff && nibeOn && canOffNibe)) {\n    if (!nibeCooldownOk && !forceStart) {\n        actions = actions.filter(function(a) { return a !== \"nibe_on\" && a !== \"nibe_off\"; });\n        reason += \" ⏳COOLDOWN\";\n    } else {\n        flow.set(\"last_nibe_switch\", now);\n    }\n}\n\n// === FINÁLNÍ BEZPEČNOSTNÍ POJISTKA: NIBE a patrony nikdy současně ===\nvar hasNibeOnFinal = actions.indexOf(\"nibe_on\") > -1;\nvar hasPatOnFinal = actions.indexOf(\"p1_on\") > -1 || actions.indexOf(\"p2_on\") > -1 || actions.indexOf(\"p3_on\") > -1;\nvar patronyRunning = p1on || p2on || p3on;\nif (hasNibeOnFinal && (hasPatOnFinal || patronyRunning)) {\n    actions = actions.filter(function(a) { return a !== \"nibe_on\"; });\n    reason += \" ⚠️MUTEX:NIBE blokováno patronami\";\n}\nif (hasPatOnFinal && nibeOn) {\n    actions = actions.filter(function(a) { return a !== \"p1_on\" && a !== \"p2_on\" && a !== \"p3_on\"; });\n    reason += \" ⚠️MUTEX:patrony blokovány NIBE\";\n}\n\n// === TOPENÍ MOD: zapsat do global pro HA input_select ===\n// === TOPENÍ MOD: zapsat do global pro HA input_select ===\nglobal.set(\"topeni_mod\", topeniModAktivni);\n\n// === GLOBAL: cerpadlo_topi pro FVE blokaci ===\nvar isHeating = pumpState.indexOf(\"Vytápění\") > -1;\nvar isTUV = pumpState.indexOf(\"Ohřev vody\") > -1 || pumpState.indexOf(\"TUV\") > -1;\n// Pokud NIBE běží s velkým solárním ziskem, NEBLOKOVAT vybíjení baterie\nvar nibeBlkDisch = flow.get(\"nibe_block_discharge\") !== false;  // default true\nglobal.set(\"cerpadlo_topi\", (isHeating || isTUV) && nibeBlkDisch);\n\n// === STATUS ===\nvar st = [];\nst.push(automatizace ? (letniRezim ? \"LÉTO\" : \"ZIMA\") : \"OFF\");\nst.push(indoorTemp.toFixed(1) + \"/\" + effTarget.toFixed(1) + \"°C\");\nst.push(\"Tank:\" + tankTemp.toFixed(0));\nst.push(\"Lv\" + lvl);\nif (actions.length > 0) st.push(\"→\" + actions.join(\",\"));\n\nvar color = \"green\";\nif (!automatizace) color = \"grey\";\nelse if (indoorTemp < NOUZ_TEMP) color = \"red\";\nelse if (isDraha || patTarget > 0) color = \"yellow\";\nnode.status({fill: color, shape: \"dot\", text: st.join(\" | \")});\n\n// === OUTPUT ===\n// O1: actions array → router switch\n// O2: debug/status\nvar actionMsgs = null;\nif (actions.length > 0) {\n    actionMsgs = actions.map(function(a) { return {action: a}; });\n}\nvar statusMsg = {\n    payload: {\n        automatizace: automatizace, letniRezim: letniRezim,\n        indoorTemp: indoorTemp, targetTemp: effTarget,\n        tankTemp: tankTemp, dm: dm, outdoorTemp: outdoorTemp,\n        priceLevel: lvl, isDraha: isDraha, isNight: isNight,\n        nibeOn: nibeOn, obehOn: obehOn, patrony: actPat, patTarget: patTarget,\n        fireplace: fireplace, batSoc: batSoc, prebytek: prebytek,\n        actions: actions, reason: reason\n    }\n};\nreturn [actionMsgs, statusMsg];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 119,
        "wires": [
            [
                "htg_action_switch"
            ],
            [
                "htg_debug",
                "htg_topeni_mod_change"
            ]
        ]
    },
    {
        "id": "htg_action_switch",
        "type": "switch",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Akce router",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "nibe_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "nibe_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "obehove_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "obehove_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p1_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p1_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p2_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p2_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p3_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p3_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ventil_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "cool_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "cool_off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 13,
        "x": 110,
        "y": 700,
        "wires": [
            [
                "htg_svc_nibe_on"
            ],
            [
                "htg_svc_nibe_off"
            ],
            [
                "htg_svc_obehove_on"
            ],
            [
                "htg_svc_obehove_off"
            ],
            [
                "htg_svc_p1_on"
            ],
            [
                "htg_svc_p1_off"
            ],
            [
                "htg_svc_p2_on"
            ],
            [
                "htg_svc_p2_off"
            ],
            [
                "htg_svc_p3_on"
            ],
            [
                "htg_svc_p3_off"
            ],
            [
                "htg_svc_ventil_off"
            ],
            [
                "htg_svc_cool_on"
            ],
            [
                "htg_svc_cool_off"
            ]
        ]
    },
    {
        "id": "htg_svc_obehove_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Oběhové ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.horousany_termostat_prizemi_kote"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 340,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_obehove_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Oběhové OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.horousany_termostat_prizemi_kote"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 340,
        "y": 530,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p1_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 1 ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.patrona_faze_1"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 340,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p1_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 1 OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.patrona_faze_1"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 340,
        "y": 630,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p2_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 2 ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.patrona_faze_3_2"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 340,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p2_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 2 OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.patrona_faze_3_2"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 340,
        "y": 730,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p3_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 3 ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.patrona_faze_3"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 340,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p3_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 3 OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.patrona_faze_3"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 340,
        "y": 830,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_ventil_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Ventil OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.bazen_ventil_smesovac"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 331,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_debug",
        "type": "debug",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Heating Status",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "payload.reason",
        "targetType": "msg",
        "statusVal": "payload.reason",
        "statusType": "auto",
        "x": 620,
        "y": 179,
        "wires": []
    },
    {
        "id": "htg_prot_trig",
        "type": "server-state-changed",
        "z": "f1e2d3c4b5a60001",
        "g": "f1e2d3c4b5a60004",
        "name": "NIBE stav změna",
        "server": "c7421fe2.cb11c",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.nibe_aktualni_realny_stav"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": true,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 120,
        "y": 1080,
        "wires": [
            [
                "htg_prot_func"
            ]
        ]
    },
    {
        "id": "htg_prot_func",
        "type": "function",
        "z": "f1e2d3c4b5a60001",
        "g": "f1e2d3c4b5a60004",
        "name": "Detekce topení vs TUV",
        "func": "// Detekce topení vs chlazení — blokace vybíjení baterie\nvar state = msg.payload || \"\";\nvar isHeating = state.indexOf(\"Vytápění\") > -1;\nvar isTUV = state.indexOf(\"Ohřev vody\") > -1 || state.indexOf(\"TUV\") > -1;\nvar blockDischarge = isHeating || isTUV;\nmsg.blockDischarge = blockDischarge;\nvar txt = blockDischarge\n    ? \"Blokace (\" + (isHeating ? \"topení\" : \"TUV\") + \")\"\n    : \"OK - \" + state.substring(0, 30);\nnode.status({fill: blockDischarge ? \"yellow\" : \"green\", shape: \"dot\", text: txt});\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1080,
        "wires": [
            [
                "htg_prot_set"
            ]
        ]
    },
    {
        "id": "htg_prot_set",
        "type": "change",
        "z": "f1e2d3c4b5a60001",
        "g": "f1e2d3c4b5a60004",
        "name": "Set cerpadlo_topi",
        "rules": [
            {
                "t": "set",
                "p": "cerpadlo_topi",
                "pt": "global",
                "to": "blockDischarge",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 580,
        "y": 1080,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_nibe_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "NIBE ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.nibe_topeni"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 330,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_nibe_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "NIBE OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.nibe_topeni"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 340,
        "y": 430,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_cool_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Chlazení ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.nibe_chlazeni"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 333,
        "y": 925,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_cool_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Chlazení OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.nibe_chlazeni"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 344,
        "y": 972,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_away_trigger",
        "type": "server-state-changed",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_away",
        "name": "Jsme doma změna",
        "server": "c7421fe2.cb11c",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.jsme_doma"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 130,
        "y": 1380,
        "wires": [
            [
                "htg_away_func"
            ]
        ]
    },
    {
        "id": "htg_away_func",
        "type": "function",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_away",
        "name": "Away mode",
        "func": "// Režim nepřítomnosti — snížení teploty když nejsme doma\nvar config = global.get(\"fve_config\") || {};\nvar AWAY_TEMP = config.topeni_teplota_nepritomnost || 21;\nvar letniRezim = config.letni_rezim === true;\n\nfunction getState(id) {\n    var e = global.get(\"homeassistant.homeAssistant.states['\" + id + \"']\") || {};\n    return e.state;\n}\nfunction getFloat(id, def) {\n    var v = parseFloat(getState(id));\n    return isNaN(v) ? (def || 0) : v;\n}\n\nvar jsme_doma = getState(\"input_boolean.jsme_doma\") === \"on\";\nvar currentTemp = getFloat(\"input_number.nastavena_teplota_v_dome\", 22);\nvar savedTemp = flow.get(\"away_saved_temp\");\n\nif (!jsme_doma && !letniRezim) {\n    // Odchod z domu v zimě → snížit teplotu\n    if (currentTemp > AWAY_TEMP) {\n        // Uložit aktuální teplotu jen pokud jsme ji ještě neuložili\n        if (!savedTemp || savedTemp <= AWAY_TEMP) {\n            flow.set(\"away_saved_temp\", currentTemp);\n        }\n        node.status({fill:\"yellow\", shape:\"dot\", text:\"PRYČ → \" + AWAY_TEMP + \"°C (uloženo \" + currentTemp + \"°C)\"});\n        return {payload: AWAY_TEMP};\n    } else {\n        node.status({fill:\"yellow\", shape:\"ring\", text:\"PRYČ | teplota už \" + currentTemp + \"°C\"});\n        return null;\n    }\n} else if (jsme_doma && savedTemp && savedTemp > AWAY_TEMP) {\n    // Příchod domů → obnovit uloženou teplotu\n    var restoreTemp = savedTemp;\n    flow.set(\"away_saved_temp\", null);\n    node.status({fill:\"green\", shape:\"dot\", text:\"DOMA → \" + restoreTemp + \"°C (obnoveno)\"});\n    return {payload: restoreTemp};\n} else {\n    node.status({fill:\"grey\", shape:\"ring\", text: jsme_doma ? \"DOMA\" : (letniRezim ? \"LÉTO\" : \"PRYČ\")});\n    return null;\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 1380,
        "wires": [
            [
                "htg_away_set_temp"
            ]
        ]
    },
    {
        "id": "htg_away_set_temp",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_away",
        "name": "Nastav teplotu",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.nastavena_teplota_v_dome"
        ],
        "labelId": [],
        "data": "{\"value\": {{payload}}}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_number",
        "service": "set_value",
        "x": 570,
        "y": 1380,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_topeni_mod_change",
        "type": "change",
        "z": "f1e2d3c4b5a60001",
        "g": "htg_g_topeni_mod",
        "name": "Nastav topeni_mod",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "topeni_mod",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 130,
        "y": 1180,
        "wires": [
            [
                "htg_topeni_mod_api"
            ]
        ]
    },
    {
        "id": "htg_topeni_mod_api",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "htg_g_topeni_mod",
        "name": "Set topeni_mod",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.topeni_mod"
        ],
        "labelId": [],
        "data": "{\"option\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 350,
        "y": 1180,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_reload_input_select_inject",
        "type": "inject",
        "z": "f1e2d3c4b5a60001",
        "g": "htg_g_reload",
        "name": "Reload input_select (startup)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 8,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 180,
        "y": 1280,
        "wires": [
            [
                "htg_reload_input_select_api"
            ]
        ]
    },
    {
        "id": "htg_reload_input_select_api",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "htg_g_reload",
        "name": "Reload input_select",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.reload",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "reload",
        "x": 400,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "pat_korekce_inject",
        "type": "inject",
        "z": "f1e2d3c4b5a60001",
        "g": "htg_g_pat_korekce",
        "name": "Patrony korekce (5s)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "5",
        "crontab": "",
        "once": true,
        "onceDelay": 10,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 280,
        "wires": [
            [
                "pat_korekce_func"
            ]
        ]
    },
    {
        "id": "pat_korekce_func",
        "type": "function",
        "z": "f1e2d3c4b5a60001",
        "g": "htg_g_pat_korekce",
        "name": "Patrony korekce vybíjení",
        "func": "// Patrony korekce — každých 5s\n// Řídí počet aktivních fází pokud patrony běží.\n// Hlavní loop (60s) jen ZAPNE patrony pokud actPat===0 a podmínky OK.\n// Jakmile patrony jednou běží, tento 5s cyklus přebírá řízení.\n\nfunction getState(id) {\n    var e = global.get(\"homeassistant.homeAssistant.states['\" + id + \"']\") || {};\n    return e.state;\n}\nfunction getFloat(id, def) {\n    var v = parseFloat(getState(id));\n    return isNaN(v) ? (def || 0) : v;\n}\nfunction getBool(id) { return getState(id) === \"on\"; }\n\n// Aktuální stav fází\nvar p1on = getBool(\"switch.patrona_faze_1\");\nvar p2on = getBool(\"switch.patrona_faze_3_2\");\nvar p3on = getBool(\"switch.patrona_faze_3\");\nvar actPat = (p1on ? 1 : 0) + (p2on ? 1 : 0) + (p3on ? 1 : 0);\n\n// Pokud žádná fáze neběží — hlavní loop rozhodne, my jen status\nif (actPat === 0) {\n    node.status({fill:\"grey\", shape:\"dot\", text:\"Patrony OFF — řídí hlavní loop\"});\n    return null;\n}\n\n// Patrony běží — tento cyklus řídí počet fází\nvar battMinus = getFloat(\"sensor.nabijeni_baterii_minus\", 0);\nvar prebytek = getFloat(\"sensor.fve_dostupny_prebytek\", 0);\nvar DISCHARGE_LIMIT = 200;  // W\nvar MIN_PRETOK = 3000;       // W na fázi (z config, zde hardcode jako fallback)\nvar config = global.get(\"fve_config\") || {};\nMIN_PRETOK = config.topeni_min_pretok_patron_w || 3000;\nvar PATRON_W = config.topeni_patron_faze_w || 3000;\n\n// Dostupný výkon pro patrony (přebytek + výkon aktuálně běžících fází)\nvar availPat = prebytek + actPat * PATRON_W;\n\n// Kolik fází přebytek dovolí\nvar prebytekFaze = 0;\nif (availPat >= MIN_PRETOK * 3)      prebytekFaze = 3;\nelse if (availPat >= MIN_PRETOK * 2) prebytekFaze = 2;\nelse if (availPat >= MIN_PRETOK)     prebytekFaze = 1;\n\nvar actions = [];\nvar newTarget = actPat;\n\nif (battMinus > DISCHARGE_LIMIT) {\n    // Baterie se vybíjí — sníž o 1\n    newTarget = Math.max(0, actPat - 1);\n    node.status({fill:\"red\", shape:\"dot\", text:\"↓ \" + actPat + \"→\" + newTarget + \"f batt_minus=\" + Math.round(battMinus) + \"W\"});\n} else if (prebytekFaze > actPat) {\n    // Přebytek vzrostl a baterie se nevybíjí — zvyš o 1\n    newTarget = Math.min(3, actPat + 1);\n    node.status({fill:\"yellow\", shape:\"dot\", text:\"↑ \" + actPat + \"→\" + newTarget + \"f avail=\" + Math.round(availPat) + \"W\"});\n} else if (prebytekFaze < actPat) {\n    // Přebytek klesl — sníž na to co přebytek dovolí\n    newTarget = prebytekFaze;\n    node.status({fill:\"orange\", shape:\"dot\", text:\"↓prebytek \" + actPat + \"→\" + newTarget + \"f avail=\" + Math.round(availPat) + \"W\"});\n} else {\n    // Vše OK — ustálený stav\n    node.status({fill:\"green\", shape:\"dot\", text:\"OK \" + actPat + \"f batt=\" + Math.round(battMinus) + \"W avail=\" + Math.round(availPat) + \"W\"});\n    return null;\n}\n\nif (newTarget === actPat) {\n    return null;\n}\n\n// Zapni/vypni fáze dle newTarget\nif (newTarget > actPat) {\n    // Zapni chybějící fáze (od nejnižší)\n    if (newTarget >= 1 && !p1on) actions.push({action: \"p1_on\"});\n    if (newTarget >= 2 && !p2on) actions.push({action: \"p2_on\"});\n    if (newTarget >= 3 && !p3on) actions.push({action: \"p3_on\"});\n} else {\n    // Vypni přebytečné fáze (od nejvyšší)\n    if (newTarget < 3 && p3on) actions.push({action: \"p3_off\"});\n    if (newTarget < 2 && p2on) actions.push({action: \"p2_off\"});\n    if (newTarget < 1 && p1on) actions.push({action: \"p1_off\"});\n}\n\nif (actions.length > 0) {\n    return [actions];\n}\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 280,
        "wires": [
            [
                "pat_korekce_router"
            ]
        ]
    },
    {
        "id": "pat_korekce_router",
        "type": "switch",
        "z": "f1e2d3c4b5a60001",
        "g": "htg_g_pat_korekce",
        "name": "Korekce router",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "p1_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p2_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p3_off",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 3,
        "x": 760,
        "y": 280,
        "wires": [
            [
                "htg_svc_p1_off"
            ],
            [
                "htg_svc_p2_off"
            ],
            [
                "htg_svc_p3_off"
            ]
        ]
    }
]