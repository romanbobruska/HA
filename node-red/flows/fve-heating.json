[
    {
        "id": "f1e2d3c4b5a60001",
        "type": "tab",
        "label": "FVE Heating v2",
        "disabled": false,
        "info": "Kompletní řízení topení domu v2.0\nNIBE + oběhové čerpadlo + patrony + ventil + chlazení"
    },
    {
        "id": "heating_g_main_v2",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Řízení topení",
        "style": {
            "label": true
        },
        "nodes": [
            "htg_inject_60s",
            "htg_trig_auto",
            "htg_trig_temp",
            "htg_main_func",
            "htg_debug"
        ]
    },
    {
        "id": "heating_g_exec_v2",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Exekuce akcí",
        "style": {
            "label": true
        },
        "nodes": [
            "htg_action_switch",
            "htg_svc_nibe_on",
            "htg_svc_nibe_off",
            "htg_svc_obehove_on",
            "htg_svc_obehove_off",
            "htg_svc_p1_on",
            "htg_svc_p1_off",
            "htg_svc_p2_on",
            "htg_svc_p2_off",
            "htg_svc_p3_on",
            "htg_svc_p3_off",
            "htg_svc_ventil_off",
            "htg_svc_cool_on",
            "htg_svc_cool_off"
        ]
    },
    {
        "id": "f1e2d3c4b5a60004",
        "type": "group",
        "z": "f1e2d3c4b5a60001",
        "name": "Ochrana baterie",
        "style": {
            "label": true
        },
        "nodes": [
            "htg_prot_trig",
            "htg_prot_func",
            "htg_prot_set"
        ]
    },
    {
        "id": "htg_inject_60s",
        "type": "inject",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Každých 60s",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "timer",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 80,
        "wires": [
            [
                "htg_main_func"
            ]
        ]
    },
    {
        "id": "htg_trig_auto",
        "type": "server-state-changed",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Automatizace změna",
        "server": "c7421fe2.cb11c",
        "version": 5,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entityId": "input_boolean.automatizovat_topeni",
        "entityIdType": "exact",
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 140,
        "y": 140,
        "wires": [
            [
                "htg_main_func"
            ]
        ]
    },
    {
        "id": "htg_trig_temp",
        "type": "server-state-changed",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Teplota změna",
        "server": "c7421fe2.cb11c",
        "version": 5,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entityId": "sensor.hp2551ae_pro_v2_1_0_indoor_temperature",
        "entityIdType": "exact",
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 140,
        "y": 200,
        "wires": [
            [
                "htg_main_func"
            ]
        ]
    },
    {
        "id": "htg_main_func",
        "type": "function",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Řízení topení v2.0",
        "func": "// FVE Heating Control v2.0 — Kompletní řízení topení domu\n// Řídí: NIBE (47371), oběhové čerpadlo, patrony (3 fáze), bazénový ventil, chlazení\n\nvar config = global.get(\"fve_config\") || {};\nvar prices = global.get(\"fve_prices_forecast\") || [];\n\n// === HELPER ===\nfunction getState(id) {\n    var e = global.get(\"homeassistant.homeAssistant.states['\" + id + \"']\") || {};\n    return e.state;\n}\nfunction getFloat(id, def) {\n    var v = parseFloat(getState(id));\n    return isNaN(v) ? (def || 0) : v;\n}\nfunction getBool(id) { return getState(id) === \"on\"; }\n\n// === PARAMETRY Z CONFIGU ===\nvar MIN_TANK = config.topeni_min_teplota_nadrze || 30;\nvar MAX_TANK = config.topeni_max_teplota_nadrze || 50;\nvar NOCNI_SNIZ = config.topeni_nocni_snizeni || 0.5;\nvar NOCNI_OD = config.topeni_nocni_od || 22;\nvar NOCNI_DO = config.topeni_nocni_do || 6;\nvar NOUZ_TEMP = config.topeni_nouzova_teplota || 18;\nvar MIN_PRETOK = config.topeni_min_pretok_patron_w || 3000;\nvar PATRON_W = config.topeni_patron_faze_w || 3000;\nvar MIN_SOC_PAT = config.topeni_min_soc_patron || 95;\nvar MAX_TANK_PAT = config.topeni_max_teplota_patron || 60;\nvar PRAH_DRAHA = config.prah_draha_energie || 12;\nvar letniRezim = config.letni_rezim === true;\n\n// === ČTENÍ STAVŮ ===\nvar automatizace = getBool(\"input_boolean.automatizovat_topeni\");\nvar targetTemp = getFloat(\"input_number.nastavena_teplota_v_dome\", 22);\nvar indoorTemp = getFloat(\"sensor.hp2551ae_pro_v2_1_0_indoor_temperature\", 20);\nvar outdoorTemp = getFloat(\"sensor.hp2551ae_pro_v2_1_0_outdoor_temperature\", 10);\nvar tankTemp = getFloat(\"sensor.teplota_smesovac_teplota\", 35);\nvar dm = getFloat(\"sensor.nibe_degree_minutes\", 0);\nvar batSoc = getFloat(\"sensor.battery_percent\", 50);\nvar prebytek = getFloat(\"sensor.fve_dostupny_prebytek\", 0);\nvar compressor = getBool(\"binary_sensor.nibe_kompresory_aktivni_binarni\");\nvar pumpState = getState(\"sensor.nibe_aktualni_realny_stav\") || \"\";\nvar fireplace = getBool(\"input_boolean.topi_se_v_krbu\");\nvar coolEnabled = getBool(\"input_boolean.chlazeni\");\nvar autoHlad = getBool(\"input_boolean.auto_ma_hlad\");\n\nvar nibeOn = getBool(\"switch.nibe_topeni\");\nvar obehOn = getBool(\"switch.horousany_termostat_prizemi_kote\");\nvar p1on = getBool(\"switch.patrona_faze_1\");\nvar p2on = getBool(\"switch.patrona_faze_3_2\");\nvar p3on = getBool(\"switch.patrona_faze_3\");\nvar ventilOn = getBool(\"switch.bazen_ventil_smesovac\");\nvar coolOn = getBool(\"switch.nibe_chlazeni\");\n\nvar hour = new Date().getHours();\nvar now = Date.now();\n\n// === CENOVÝ LEVEL ===\nvar lvl = 99;\nfor (var i = 0; i < prices.length; i++) {\n    if (prices[i].hour === hour && prices[i].minute === 0) {\n        lvl = prices[i].levelCheapestHourBuy || 99;\n        break;\n    }\n}\nif (lvl === 99) {\n    for (var j = 0; j < prices.length; j++) {\n        if (prices[j].hour === hour) {\n            lvl = prices[j].levelCheapestHourBuy || 99;\n            break;\n        }\n    }\n}\nvar isDraha = lvl >= PRAH_DRAHA;\n\n// === NOČNÍ REŽIM ===\nvar isNight = (hour >= NOCNI_OD || hour < NOCNI_DO);\nvar effTarget = isNight ? (targetTemp - NOCNI_SNIZ) : targetTemp;\n\n// === PATRONY STATE ===\nvar actPat = (p1on ? 1 : 0) + (p2on ? 1 : 0) + (p3on ? 1 : 0);\nvar availPat = prebytek + actPat * PATRON_W;\n\n// === OCHRANA ===\nvar pumpWorking = pumpState.indexOf(\"Klidový\") === -1 && pumpState !== \"\";\nvar canOffNibe = !compressor && !pumpWorking;\n\n// === ROZHODOVÁNÍ ===\nvar actions = [];\nvar reason = \"\";\nvar patTarget = 0;\nvar shutdownDone = flow.get(\"shutdown_done\") || false;\n\nif (!automatizace) {\n    // AUTOMATIZACE OFF — jednorázové nastavení, pak žádné zásahy\n    if (!shutdownDone) {\n        // NIBE: povolit topení (pro TUV), pokud kompresor neběží\n        if (canOffNibe) actions.push(\"nibe_on\");\n        if (obehOn) actions.push(\"obehove_off\");\n        if (p1on) actions.push(\"p1_off\");\n        if (p2on) actions.push(\"p2_off\");\n        if (p3on) actions.push(\"p3_off\");\n        flow.set(\"shutdown_done\", true);\n        reason = \"Automatizace OFF — jednorázové vypnutí\";\n    } else {\n        reason = \"Automatizace OFF — žádné zásahy\";\n    }\n} else {\n    flow.set(\"shutdown_done\", false);\n    // Reset summer flag pokud se změní automatizace\n    if (letniRezim) {\n        // LETNÍ REŽIM — jednorázové nastavení default stavu, pak jen chlazení\n        var summerDone = flow.get(\"summer_setup_done\") || false;\n        if (!summerDone) {\n            // Jednorázově: NIBE on (pro TUV), oběhové off, patrony off\n            if (canOffNibe) actions.push(\"nibe_on\");\n            if (obehOn) actions.push(\"obehove_off\");\n            if (p1on) actions.push(\"p1_off\");\n            if (p2on) actions.push(\"p2_off\");\n            if (p3on) actions.push(\"p3_off\");\n            flow.set(\"summer_setup_done\", true);\n            reason = \"Léto — jednorázové nastavení default\";\n        }\n\n        // Chlazení — běží stále v létě\n        if (coolEnabled) {\n            if (!coolOn && indoorTemp > effTarget + 1) {\n                actions.push(\"cool_on\");\n                reason = \"Chlazení ON (\" + indoorTemp.toFixed(1) + \">\" + (effTarget+1).toFixed(1) + \"°C)\";\n            } else if (coolOn && indoorTemp < effTarget) {\n                actions.push(\"cool_off\");\n                reason = \"Chlazení OFF (\" + indoorTemp.toFixed(1) + \"<\" + effTarget.toFixed(1) + \"°C)\";\n            } else {\n                reason = \"Léto | \" + indoorTemp.toFixed(1) + \"/\" + effTarget.toFixed(1) + \"°C\" + (coolOn ? \" | Chlazení\" : \"\");\n            }\n        } else {\n            if (coolOn) actions.push(\"cool_off\");\n            reason = \"Léto | chlazení vypnuto\";\n        }\n    } else {\n        // ZIMNÍ REŽIM\n        flow.set(\"summer_setup_done\", false);\n\n        // 1. Bazénový ventil - kontrola\n        if (ventilOn) actions.push(\"ventil_off\");\n\n        // 2. Chlazení OFF v zimě\n        if (coolOn) actions.push(\"cool_off\");\n\n        // 3. Patrony - přetokové vytápění\n        var patronyActive = false;\n        if (batSoc >= MIN_SOC_PAT && !autoHlad && tankTemp < MAX_TANK_PAT) {\n            if (availPat >= MIN_PRETOK * 3) {\n                patTarget = 3; patronyActive = true;\n            } else if (availPat >= MIN_PRETOK * 2) {\n                patTarget = 2; patronyActive = true;\n            } else if (availPat >= MIN_PRETOK) {\n                patTarget = 1; patronyActive = true;\n            }\n        }\n\n        // Patrony ON/OFF\n        var p1want = patTarget >= 1;\n        var p2want = patTarget >= 2;\n        var p3want = patTarget >= 3;\n        if (p1want !== p1on) actions.push(p1want ? \"p1_on\" : \"p1_off\");\n        if (p2want !== p2on) actions.push(p2want ? \"p2_on\" : \"p2_off\");\n        if (p3want !== p3on) actions.push(p3want ? \"p3_on\" : \"p3_off\");\n\n        // 4. NIBE řízení\n        if (fireplace) {\n            // Krb aktivní → NIBE OFF (krb nahřívá nádrž místo NIBE)\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        } else if (patronyActive) {\n            // Patrony aktivní → NIBE OFF (vzájemná exkluzivita)\n            if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n        } else if (isDraha) {\n            if (indoorTemp < NOUZ_TEMP) {\n                // NOUZOVÉ\n                if (!nibeOn) actions.push(\"nibe_on\");\n            } else {\n                if (nibeOn && canOffNibe) actions.push(\"nibe_off\");\n            }\n        } else {\n            // Levné/střední → povolit NIBE\n            if (!nibeOn) actions.push(\"nibe_on\");\n        }\n\n        // 5. Oběhové čerpadlo\n        var tankOk = tankTemp >= MIN_TANK && tankTemp <= MAX_TANK;\n        var needsHeat = indoorTemp < effTarget;\n\n        // 5. Oběhové čerpadlo (při krbu NESAHAT - řídí jiná automatika)\n        if (!fireplace) {\n            if (tankOk && needsHeat) {\n                if (!obehOn) {\n                    actions.push(\"obehove_on\");\n                    flow.set(\"last_heat_switch\", now);\n                }\n            } else {\n                if (obehOn) {\n                    actions.push(\"obehove_off\");\n                    flow.set(\"last_heat_switch\", now);\n                }\n            }\n        }\n\n        // Reason\n        var parts = [];\n        parts.push(isDraha ? \"DRAHÁ(Lv\" + lvl + \")\" : \"Lv\" + lvl);\n        parts.push(\"In:\" + indoorTemp.toFixed(1) + \"/\" + effTarget.toFixed(1) + \"°C\");\n        parts.push(\"Tank:\" + tankTemp.toFixed(0) + \"°C\");\n        parts.push(\"DM:\" + Math.round(dm));\n        parts.push(\"Out:\" + outdoorTemp.toFixed(0) + \"°C\");\n        if (patronyActive) parts.push(\"PAT:\" + patTarget + \"f(\" + Math.round(availPat) + \"W)\");\n        if (fireplace) parts.push(\"KRB\");\n        if (isNight) parts.push(\"NOC\");\n        reason = parts.join(\" | \");\n    }\n}\n\n// === OCHRANA: NIBE nelze vypnout pokud pracuje ===\nif (actions.indexOf(\"nibe_off\") > -1 && !canOffNibe) {\n    actions = actions.filter(function(a) { return a !== \"nibe_off\"; });\n    reason += \" ⚠️OCHRANA:NIBE pracuje\";\n}\n\n// === GLOBAL: cerpadlo_topi pro FVE blokaci ===\nvar isHeating = pumpState.indexOf(\"Vytápění\") > -1;\nvar isTUV = pumpState.indexOf(\"Ohřev vody\") > -1 || pumpState.indexOf(\"TUV\") > -1;\nglobal.set(\"cerpadlo_topi\", isHeating || isTUV);\n\n// === STATUS ===\nvar st = [];\nst.push(automatizace ? (letniRezim ? \"LÉTO\" : \"ZIMA\") : \"OFF\");\nst.push(indoorTemp.toFixed(1) + \"/\" + effTarget.toFixed(1) + \"°C\");\nst.push(\"Tank:\" + tankTemp.toFixed(0));\nst.push(\"Lv\" + lvl);\nif (actions.length > 0) st.push(\"→\" + actions.join(\",\"));\n\nvar color = \"green\";\nif (!automatizace) color = \"grey\";\nelse if (indoorTemp < NOUZ_TEMP) color = \"red\";\nelse if (isDraha || patTarget > 0) color = \"yellow\";\nnode.status({fill: color, shape: \"dot\", text: st.join(\" | \")});\n\n// === OUTPUT ===\n// O1: actions array → router switch\n// O2: debug/status\nvar actionMsgs = null;\nif (actions.length > 0) {\n    actionMsgs = actions.map(function(a) { return {action: a}; });\n}\nvar statusMsg = {\n    payload: {\n        automatizace: automatizace, letniRezim: letniRezim,\n        indoorTemp: indoorTemp, targetTemp: effTarget,\n        tankTemp: tankTemp, dm: dm, outdoorTemp: outdoorTemp,\n        priceLevel: lvl, isDraha: isDraha, isNight: isNight,\n        nibeOn: nibeOn, obehOn: obehOn, patrony: actPat, patTarget: patTarget,\n        fireplace: fireplace, batSoc: batSoc, prebytek: prebytek,\n        actions: actions, reason: reason\n    }\n};\nreturn [actionMsgs, statusMsg];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 140,
        "wires": [
            [
                "htg_action_switch"
            ],
            [
                "htg_debug"
            ]
        ]
    },
    {
        "id": "htg_action_switch",
        "type": "switch",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Akce router",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "nibe_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "nibe_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "obehove_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "obehove_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p1_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p1_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p2_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p2_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p3_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "p3_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ventil_off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "cool_on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "cool_off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 13,
        "x": 150,
        "y": 500,
        "wires": [
            [
                "htg_svc_nibe_on"
            ],
            [
                "htg_svc_nibe_off"
            ],
            [
                "htg_svc_obehove_on"
            ],
            [
                "htg_svc_obehove_off"
            ],
            [
                "htg_svc_p1_on"
            ],
            [
                "htg_svc_p1_off"
            ],
            [
                "htg_svc_p2_on"
            ],
            [
                "htg_svc_p2_off"
            ],
            [
                "htg_svc_p3_on"
            ],
            [
                "htg_svc_p3_off"
            ],
            [
                "htg_svc_ventil_off"
            ],
            [
                "htg_svc_cool_on"
            ],
            [
                "htg_svc_cool_off"
            ]
        ]
    },
    {
        "id": "htg_svc_obehove_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Oběhové ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.horousany_termostat_prizemi_kote"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 380,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_obehove_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Oběhové OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.horousany_termostat_prizemi_kote"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 380,
        "y": 490,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p1_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 1 ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.patrona_faze_1"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 380,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p1_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 1 OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.patrona_faze_1"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 380,
        "y": 590,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p2_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 2 ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.patrona_faze_3_2"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 380,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p2_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 2 OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.patrona_faze_3_2"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 380,
        "y": 690,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p3_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 3 ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.patrona_faze_3"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 380,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_p3_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Patrona 3 OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.patrona_faze_3"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 380,
        "y": 790,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_ventil_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Ventil OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.bazen_ventil_smesovac"
        ],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 380,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_debug",
        "type": "debug",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_main_v2",
        "name": "Heating Status",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "payload.reason",
        "targetType": "msg",
        "statusVal": "payload.reason",
        "statusType": "auto",
        "x": 600,
        "y": 200,
        "wires": []
    },
    {
        "id": "htg_prot_trig",
        "type": "server-state-changed",
        "z": "f1e2d3c4b5a60001",
        "g": "f1e2d3c4b5a60004",
        "name": "NIBE stav změna",
        "server": "c7421fe2.cb11c",
        "version": 5,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entityId": "sensor.nibe_aktualni_realny_stav",
        "entityIdType": "exact",
        "outputInitially": true,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 140,
        "y": 900,
        "wires": [
            [
                "htg_prot_func"
            ]
        ]
    },
    {
        "id": "htg_prot_func",
        "type": "function",
        "z": "f1e2d3c4b5a60001",
        "g": "f1e2d3c4b5a60004",
        "name": "Detekce topení vs TUV",
        "func": "// Detekce topení vs chlazení — blokace vybíjení baterie\nvar state = msg.payload || \"\";\nvar isHeating = state.indexOf(\"Vytápění\") > -1;\nvar isTUV = state.indexOf(\"Ohřev vody\") > -1 || state.indexOf(\"TUV\") > -1;\nvar blockDischarge = isHeating || isTUV;\nmsg.blockDischarge = blockDischarge;\nvar txt = blockDischarge\n    ? \"Blokace (\" + (isHeating ? \"topení\" : \"TUV\") + \")\"\n    : \"OK - \" + state.substring(0, 30);\nnode.status({fill: blockDischarge ? \"yellow\" : \"green\", shape: \"dot\", text: txt});\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 900,
        "wires": [
            [
                "htg_prot_set"
            ]
        ]
    },
    {
        "id": "htg_prot_set",
        "type": "change",
        "z": "f1e2d3c4b5a60001",
        "g": "f1e2d3c4b5a60004",
        "name": "Set cerpadlo_topi",
        "rules": [
            {
                "t": "set",
                "p": "cerpadlo_topi",
                "pt": "global",
                "to": "blockDischarge",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 600,
        "y": 900,
        "wires": [
            []
        ]
    },
    {
        "id": "c7421fe2.cb11c",
        "type": "server",
        "name": "Home Assistant",
        "version": 5,
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "y|yes|true|on|home|open",
        "connectionDelay": true,
        "cacheJson": true,
        "heartbeat": false,
        "heartbeatInterval": 30,
        "areaSelector": "friendlyName",
        "deviceSelector": "friendlyName",
        "entitySelector": "friendlyName",
        "statusSeparator": "at: ",
        "statusYear": "hidden",
        "statusMonth": "short",
        "statusDay": "numeric",
        "statusHourCycle": "h23",
        "statusTimeFormat": "h:m",
        "enableGlobalContextStore": true
    },
    {
        "id": "htg_svc_nibe_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "NIBE ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.nibe_topeni"
        ],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 380,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_nibe_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "NIBE OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.nibe_topeni"
        ],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 380,
        "y": 390,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_cool_on",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Chlazení ON",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.nibe_chlazeni"
        ],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 380,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "htg_svc_cool_off",
        "type": "api-call-service",
        "z": "f1e2d3c4b5a60001",
        "g": "heating_g_exec_v2",
        "name": "Chlazení OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "labelId": [],
        "entityId": [
            "switch.nibe_chlazeni"
        ],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 380,
        "y": 690,
        "wires": [
            []
        ]
    }
]