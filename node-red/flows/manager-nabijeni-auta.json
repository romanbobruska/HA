[
    {
        "id": "7ceb7c5337692ae5",
        "type": "tab",
        "label": "Manager nabíjení auta",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "40686c99d0404f36",
        "type": "inject",
        "z": "7ceb7c5337692ae5",
        "name": "5 minut",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 80,
        "wires": [
            [
                "main_logic_func"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "8f1a7b3a93bc777c",
        "type": "server-state-changed",
        "z": "7ceb7c5337692ae5",
        "name": "Stav wallboxu",
        "server": "c7421fe2.cb11c",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.charger_state_garage",
                "sensor.stav_wallboxu_venek"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 330,
        "y": 80,
        "wires": [
            [
                "main_logic_func"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "main_logic_func",
        "type": "function",
        "z": "7ceb7c5337692ae5",
        "name": "Rozhodovací logika v2.3",
        "func": "// Manager nabíjení auta v2.3\n// OPRAVA: forecast čte přímo z HA entit (ne z fve_config, který je po restartu prázdný)\n// Výstupy: [1] stop → grid+solar OFF, [2] nabíjení ze slunce, [3] nabíjení ze sítě\nfunction getState(id) {\n    var e = global.get(\"homeassistant.homeAssistant.states['\" + id + \"']\") || {};\n    return e.state;\n}\nfunction getBool(id) { return getState(id) === \"on\"; }\nfunction getFloat(id, def) {\n    var v = parseFloat(getState(id));\n    return isNaN(v) ? (def || 0) : v;\n}\n\nvar config = global.get(\"fve_config\") || {};\n\nvar autoHlad     = getBool(\"input_boolean.auto_ma_hlad\");\nvar automatizace = getBool(\"input_boolean.automatizovat_nabijeni_auta\");\nvar solarniRezim = getBool(\"input_boolean.solarni_rezim_nabijeni_auta\");\nvar letniRezim   = getBool(\"input_boolean.letni_rezim\");\n\n// OPRAVA: číst forecast PŘÍMO z HA entity (ne z fve_config!)\n// Po restartu NR je fve_config.forecast_vyroba_dnes = undefined/0\n// HA websocket store (homeassistant.homeAssistant.states) je vždy aktuální\nvar vyrobaDnes   = getFloat(\"input_number.predpoved_solarni_vyroby_dnes\", 0);\nvar vyrobaZitra  = getFloat(\"input_number.predpoved_solarni_vyroby_zitra\", 0);\nvar batSoc       = getFloat(\"sensor.battery_percent\", 0);\nvar rozdiVyroby  = getFloat(\"sensor.rozdil_vyroby_a_spotreby\", 0);\n\nvar FORECAST_KWH = config.nabijeni_auta_forecast_kwh || 40;\nvar MIN_SOC      = config.nabijeni_auta_min_soc      || 95;\nvar MIN_SOLAR_W  = config.nabijeni_auta_solar_w      || 4000;\n\n// 1. Auto nemá hlad → stop (grid+solar OFF)\nif (!autoHlad) {\n    node.status({fill:\"grey\", shape:\"ring\", text:\"Nemá hlad → stop\"});\n    return [[msg], null, null];\n}\n\n// 2. Automatizace vypnuta → stop\nif (!automatizace) {\n    node.status({fill:\"grey\", shape:\"ring\", text:\"Automatizace OFF → stop\"});\n    return [[msg], null, null];\n}\n\n// 3. MUTEX: NIBE topí → auto NESMÍ nabíjet (nikdy současně!)\n// Ultra levná: bypass - auto může nabíjet i když NIBE topí\nvar ultraLevna = global.get(\"ultra_levna_energie\") || false;\nvar cerpadloTopi = global.get(\"cerpadlo_topi\") || false;\nif (cerpadloTopi && !ultraLevna) {\n    node.status({fill:\"red\", shape:\"ring\", text:\"⚠️MUTEX: NIBE topí → auto STOP\"});\n    return [[msg], null, null];\n}\n\n// 4. Solární režim ON → slunce (jen pokud je dostatek přebytku nebo SOC OK)\nif (solarniRezim) {\n    if (rozdiVyroby > MIN_SOLAR_W || batSoc > MIN_SOC) {\n        node.status({fill:\"green\", shape:\"dot\", text:\"Solar ON | přebytek=\" + Math.round(rozdiVyroby) + \"W bat=\" + batSoc + \"% → slunce\"});\n        return [null, [msg], null];\n    } else {\n        node.status({fill:\"orange\", shape:\"ring\", text:\"Solar ON ale přebytek=\" + Math.round(rozdiVyroby) + \"W bat=\" + batSoc + \"% → stop\"});\n        return [[msg], null, null];\n    }\n}\n\n// 5. Solární režim OFF, letní režim ON → slunce\nif (letniRezim) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Letní režim → slunce\"});\n    return [null, [msg], null];\n}\n\n// 6. Zimní režim — výroba dnes > FORECAST_KWH → slunce\nif (vyrobaDnes > FORECAST_KWH) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Dnes \" + Math.round(vyrobaDnes) + \"kWh > \" + FORECAST_KWH + \" → slunce\"});\n    return [null, [msg], null];\n}\n\n// 7. Výroba dnes nestačí, baterie > MIN_SOC — zkontroluj přebytek\nif (batSoc > MIN_SOC) {\n    if (rozdiVyroby > MIN_SOLAR_W) {\n        node.status({fill:\"green\", shape:\"dot\", text:\"Bat \" + batSoc + \"% + \" + Math.round(rozdiVyroby) + \"W → slunce\"});\n        return [null, [msg], null];\n    }\n    // Přebytek nestačí → zkontroluj výrobu zítra (fall-through)\n}\n\n// 8. Výroba zítra > FORECAST_KWH → slunce\nif (vyrobaZitra > FORECAST_KWH) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Zítra \" + Math.round(vyrobaZitra) + \"kWh > \" + FORECAST_KWH + \" → slunce\"});\n    return [null, [msg], null];\n}\n\n// 9. Nic nesplněno → nabíjení ze sítě\nnode.status({fill:\"blue\", shape:\"dot\", text:\"Síť | dnes:\" + Math.round(vyrobaDnes) + \" zítra:\" + Math.round(vyrobaZitra) + \" bat:\" + batSoc + \"%\"});\nreturn [null, null, [msg]];\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 200,
        "wires": [
            [
                "svc_solar_off_stop"
            ],
            [
                "svc_solar_off_slunce"
            ],
            [
                "svc_solar_off_sit"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "svc_grid_off",
        "type": "api-call-service",
        "z": "7ceb7c5337692ae5",
        "name": "Grid OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.nastavuj_amperaci_chargeru_grid"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 740,
        "y": 160,
        "wires": [
            []
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "svc_solar_off_stop",
        "type": "api-call-service",
        "z": "7ceb7c5337692ae5",
        "name": "Solar OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.nastavuj_amperaci_chargeru_solar"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 550,
        "y": 160,
        "wires": [
            [
                "svc_grid_off"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "svc_solar_off_slunce",
        "type": "api-call-service",
        "z": "7ceb7c5337692ae5",
        "name": "Solar OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.nastavuj_amperaci_chargeru_solar"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 550,
        "y": 200,
        "wires": [
            [
                "svc_grid_off_slunce"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "svc_grid_off_slunce",
        "type": "api-call-service",
        "z": "7ceb7c5337692ae5",
        "name": "Grid OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.nastavuj_amperaci_chargeru_grid"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 740,
        "y": 200,
        "wires": [
            [
                "link_out_slunce"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "link_out_slunce",
        "type": "link out",
        "z": "7ceb7c5337692ae5",
        "name": "Spusť nabíjení ze slunce",
        "mode": "link",
        "links": [
            "bd970168cfe6cecf"
        ],
        "x": 865,
        "y": 200,
        "wires": [],
        "g": "mgr_grp_logic"
    },
    {
        "id": "svc_solar_off_sit",
        "type": "api-call-service",
        "z": "7ceb7c5337692ae5",
        "name": "Solar OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.nastavuj_amperaci_chargeru_solar"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 550,
        "y": 240,
        "wires": [
            [
                "svc_grid_off_sit"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "svc_grid_off_sit",
        "type": "api-call-service",
        "z": "7ceb7c5337692ae5",
        "name": "Grid OFF",
        "server": "c7421fe2.cb11c",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.nastavuj_amperaci_chargeru_grid"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 740,
        "y": 240,
        "wires": [
            [
                "link_out_sit"
            ]
        ],
        "g": "mgr_grp_logic"
    },
    {
        "id": "link_out_sit",
        "type": "link out",
        "z": "7ceb7c5337692ae5",
        "name": "Spusť nabíjení ze sítě",
        "mode": "link",
        "links": [
            "4c0ccbe3229bb4f8"
        ],
        "x": 865,
        "y": 240,
        "wires": [],
        "g": "mgr_grp_logic"
    },
    {
        "id": "c7421fe2.cb11c",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "ef7e88d904689f1b",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3"
        }
    },
    {
        "id": "mgr_grp_logic",
        "type": "group",
        "z": "7ceb7c5337692ae5",
        "name": "Rozhodovací logika",
        "style": {
            "fill": "#d3e8f3",
            "label": true
        },
        "nodes": [
            "40686c99d0404f36",
            "8f1a7b3a93bc777c",
            "main_logic_func",
            "svc_grid_off",
            "svc_solar_off_stop",
            "svc_solar_off_slunce",
            "svc_grid_off_slunce",
            "link_out_slunce",
            "svc_solar_off_sit",
            "svc_grid_off_sit",
            "link_out_sit"
        ],
        "x": 14,
        "y": 60,
        "w": 965,
        "h": 220
    }
]