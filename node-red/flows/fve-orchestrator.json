[
    {
        "id": "d86bb11fab512182",
        "type": "tab",
        "label": "FVE Orchestrator",
        "disabled": false,
        "info": "Hlavní orchestrace FVE - plánování a rozhodování o módech",
        "env": []
    },
    {
        "id": "4580a451a0858d03",
        "type": "group",
        "z": "d86bb11fab512182",
        "name": "Plánování",
        "style": {
            "fill": "#e3f3d3",
            "label": true
        },
        "nodes": [
            "22e7b3b8965c20db",
            "f037d87ec94c7da2",
            "9333668b1d326a83",
            "9e0b46a9dfedea33",
            "df085ac4da095340",
            "39019d1a78677231",
            "517215d5f730e80c",
            "701e94d82c3aead0"
        ],
        "x": 14,
        "y": 19,
        "w": 952,
        "h": 162
    },
    {
        "id": "c0d4d6462d4ebded",
        "type": "group",
        "z": "d86bb11fab512182",
        "name": "Exekuce plánu",
        "style": {
            "fill": "#d3e8f3",
            "label": true
        },
        "nodes": [
            "44d31ff3c04741b7",
            "c36915a8599c5282",
            "8eef6d1d51c9c644",
            "19a783a61de3519b",
            "f10a91fcb4de6bd3",
            "7f051a6595e57c3e",
            "185f95d7c56fe799",
            "a706b353f30c25d1",
            "a86bc5233cfa0458"
        ],
        "x": 74,
        "y": 239,
        "w": 752,
        "h": 242
    },
    {
        "id": "66210c073baa5af0",
        "type": "group",
        "z": "d86bb11fab512182",
        "name": "Kontrola priorit",
        "style": {
            "fill": "#f3e8d3",
            "label": true
        },
        "nodes": [
            "fc848e97e2c781c1",
            "376106d716756636",
            "dc8da09248ec1e29"
        ],
        "x": 114,
        "y": 539,
        "w": 672,
        "h": 82
    },
    {
        "id": "22e7b3b8965c20db",
        "type": "inject",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "Každou minutu",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "15",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 60,
        "wires": [
            [
                "9333668b1d326a83"
            ]
        ]
    },
    {
        "id": "f037d87ec94c7da2",
        "type": "link in",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "← Manuální trigger",
        "links": [],
        "x": 145,
        "y": 100,
        "wires": [
            [
                "9333668b1d326a83"
            ]
        ]
    },
    {
        "id": "9333668b1d326a83",
        "type": "function",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "Sbírka dat pro plánování",
        "func": "var config = global.get(\"fve_config\") || {};\nvar status = global.get(\"fve_status\") || {};\nvar prices = global.get(\"fve_prices_forecast\") || [];\nvar forecastZitra = global.get(\"forecast_vyroba_zitra\") || 0;\nvar zbyvajiciSolar = global.get(\"zbyvajici_solar_dnes\") || 0;\nvar consumptionAnalysis = global.get(\"fve_consumption_analysis\") || {};\n\nmsg.planData = {\n    config: config,\n    status: status,\n    prices: prices,\n    forecast: {\n        zitra: forecastZitra\n    },\n    zbyvajiciSolar: zbyvajiciSolar,\n    consumptionAnalysis: consumptionAnalysis,\n    timestamp: new Date().toISOString()\n};\n\nnode.status({fill:\"blue\", shape:\"dot\", text:\"Solar: \" + Math.round(zbyvajiciSolar) + \" kWh\"});\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 60,
        "wires": [
            [
                "9e0b46a9dfedea33"
            ]
        ]
    },
    {
        "id": "9e0b46a9dfedea33",
        "type": "function",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "Výpočet plánu na 12h (v6)",
        "func": "// FVE Smart Plan v6 - Finanční optimalizace s amortizací a ztrátami\n// Cíl: Nejnižší denní platby za elektřinu\n// Pravidla:\n//   1. Nabíjet POUZE při nejnižších cenách a POUZE pokud to dává finanční smysl\n//   2. Cíl: SOC = minSOC těsně před dalším nabíjecím oknem\n//   3. Ztráty: 10% nabíjení + 10% vybíjení (round-trip ~81%)\n//   4. Pokud nemá smysl nabíjet/vybíjet → nedělej nic\n//   5. Žádné natvrdo zakódované hodnoty - vše z configu\n\nvar data = msg.planData;\nvar config = data.config || {};\nvar status = data.status || {};\nvar prices = data.prices || [];\nvar forecast = data.forecast || {};\n\nvar MODY = {\n    NORMAL: \"normal\",\n    SETRIT: \"setrit\",\n    NABIJET_ZE_SITE: \"nabijet_ze_site\",\n    PRODAVAT: \"prodavat\",\n    ZAKAZ_PRETOKU: \"zakaz_pretoku\"\n};\n\n// === PARAMETRY Z CONFIGU (žádné natvrdo zakódované hodnoty) ===\nvar kapacitaBaterie = config.kapacita_baterie_kwh || 28;\nvar minSoc = config.min_soc || 20;\nvar maxDailySoc = config.max_daily_soc || 80;\nvar amortizace = config.amortizace_baterie_czk_kwh || 1.5;\nvar chargeEfficiency = config.charge_efficiency || 0.90;\nvar dischargeEfficiency = config.discharge_efficiency || 0.90;\nvar roundTripEfficiency = chargeEfficiency * dischargeEfficiency;\nvar chargeRateKwh = config.charge_rate_kwh || 5;\nvar socDropNormal = config.soc_drop_normal_pct || 5;\nvar dailyConsumptionKwh = config.daily_consumption_kwh || 20;\nvar PRAH_LEVNA = config.prah_levna_energie || 4;\nvar PRAH_DRAHA = config.prah_draha_energie || 13;\nvar horizont = config.plan_horizon_hours || 12;\nvar maxGridW = config.max_spotreba_sit_w || 22000;\nvar maxFeedInW = config.max_feed_in_w || 7600;\nvar prodejZBaterieEnabled = config.prodej_z_baterie_enabled === true;\nvar blokaceVybijeni = config.blokace_vybijeni === true;\nvar manualMod = config.manual_mod || \"auto\";\nvar letniRezim = config.letni_rezim === true;\n\n// === AKTUÁLNÍ STAV ===\nvar currentSoc = status.battery_soc || 50;\nvar forecastZitra = forecast.zitra || 0;\nvar remainingSolarKwh = data.zbyvajiciSolar || 0;\n\n// Sledování plného nabití (údržba baterie)\nvar lastFullCharge = global.get(\"fve_last_full_charge\") || null;\nif (!lastFullCharge) {\n    global.set(\"fve_last_full_charge\", new Date().toISOString());\n    lastFullCharge = global.get(\"fve_last_full_charge\");\n}\nvar daysSinceFullCharge = lastFullCharge\n    ? Math.floor((Date.now() - new Date(lastFullCharge).getTime()) / (1000 * 60 * 60 * 24))\n    : 999;\nif (currentSoc >= 99) {\n    global.set(\"fve_last_full_charge\", new Date().toISOString());\n}\n\nvar now = new Date();\nvar currentHour = now.getHours();\n\n// === POMOCNÁ FUNKCE: CENOVÁ DATA ===\nfunction getPriceDataForHour(hour) {\n    for (var i = 0; i < prices.length; i++) {\n        if (prices[i].hour === hour) {\n            return {\n                buy: prices[i].priceCZKhourBuy || 0,\n                sell: prices[i].priceCZKhourProd || 0,\n                levelBuy: prices[i].levelCheapestHourBuy || 5,\n                levelSell: prices[i].levelMostExpensiveHourProd || 5\n            };\n        }\n    }\n    return { buy: 0, sell: 0, levelBuy: 5, levelSell: 5 };\n}\n\n// === KROK 1: CENOVÁ MAPA HORIZONTU ===\nvar hourPrices = [];\nfor (var i = 0; i < horizont; i++) {\n    var h = (currentHour + i) % 24;\n    var pd = getPriceDataForHour(h);\n    hourPrices.push({\n        offset: i,\n        hour: h,\n        buy: pd.buy,\n        levelBuy: pd.levelBuy,\n        sell: pd.sell,\n        levelSell: pd.levelSell\n    });\n}\n\n// === KROK 2: NAJDI DRAHÉ HODINY (kde baterie šetří peníze) ===\nvar expensiveHours = hourPrices.filter(function(hp) {\n    return hp.levelBuy > PRAH_LEVNA;\n});\nvar avgExpensivePrice = 0;\nif (expensiveHours.length > 0) {\n    var sum = 0;\n    for (var ei = 0; ei < expensiveHours.length; ei++) {\n        sum += expensiveHours[ei].buy;\n    }\n    avgExpensivePrice = sum / expensiveHours.length;\n}\n\n// === KROK 3: FINANČNÍ SMYSLUPLNOST NABÍJENÍ ===\n// Efektivní cena uložení 1 kWh = nákupní_cena / round_trip_eff + amortizace\n// Nabíjení má smysl pouze pokud efektivní cena < průměrná cena drahých hodin\nvar viableChargingHours = [];\nfor (var vi = 0; vi < hourPrices.length; vi++) {\n    var hp = hourPrices[vi];\n    if (hp.levelBuy > PRAH_LEVNA) continue;\n    var effectiveCost = hp.buy / roundTripEfficiency + amortizace;\n    if (effectiveCost < avgExpensivePrice) {\n        viableChargingHours.push(hp);\n    }\n}\nviableChargingHours.sort(function(a, b) { return a.buy - b.buy; });\n\n// === KROK 4: KOLIK ENERGIE POTŘEBUJI ZE SÍTĚ? ===\n// Cíl: mít SOC = minSOC těsně před dalším nabíjecím oknem\nvar hoursLeftToday = Math.max(0, 24 - currentHour);\nvar consumptionRemaining = dailyConsumptionKwh * hoursLeftToday / 24;\nvar solarForBattery = Math.max(0, remainingSolarKwh - consumptionRemaining);\n\n// Kolik kWh baterie potřebuji na pokrytí drahých hodin?\nvar batteryNeedKwh = expensiveHours.length * socDropNormal / 100 * kapacitaBaterie;\n// Kolik mám dostupné kapacity? (se ztrátou při vybíjení)\nvar availableKwh = ((currentSoc - minSoc) / 100) * kapacitaBaterie * dischargeEfficiency;\n// Čistá potřeba ze sítě (po odečtení dostupné energie a soláru, se ztrátou nabíjení)\nvar gridChargeNeeded = Math.max(0, (batteryNeedKwh - availableKwh - solarForBattery) / chargeEfficiency);\n\n// Cíl SOC po nabití\nvar targetSocFromGrid = Math.min(maxDailySoc, currentSoc + Math.round(gridChargeNeeded / kapacitaBaterie * 100));\n\n// Pokud už máme dost, nenabíjet\nif (targetSocFromGrid <= currentSoc + 3) {\n    gridChargeNeeded = 0;\n    targetSocFromGrid = currentSoc;\n}\n\n// Zimní režim: zajistit minimální nabití na maxDailySoc\nif (!letniRezim && targetSocFromGrid < maxDailySoc) {\n    targetSocFromGrid = maxDailySoc;\n    gridChargeNeeded = Math.max(0, ((targetSocFromGrid - currentSoc) / 100) * kapacitaBaterie / chargeEfficiency);\n}\n\n// Údržbové nabíjení každých 10 dní (priorita zdraví baterie)\nvar maintenanceCharge = false;\nif (daysSinceFullCharge >= 10 && targetSocFromGrid < 100) {\n    targetSocFromGrid = 100;\n    gridChargeNeeded = ((100 - currentSoc) / 100) * kapacitaBaterie / chargeEfficiency;\n    maintenanceCharge = true;\n}\n\nvar hoursNeeded = Math.ceil(gridChargeNeeded / chargeRateKwh);\n\n// === KROK 5: PŘIŘAĎ NABÍJECÍ HODINY ===\n// Pouze finančně smysluplné hodiny, seřazené od nejlevnější\nvar chargingOffsets = {};\nvar assignedHours = 0;\nfor (var ci = 0; ci < viableChargingHours.length && assignedHours < hoursNeeded; ci++) {\n    chargingOffsets[viableChargingHours[ci].offset] = true;\n    assignedHours++;\n}\n\n// Údržbové nabíjení: pokud nestačí levné hodiny, použij nejlevnější zbylé (zdraví baterie)\nif (maintenanceCharge && assignedHours < hoursNeeded) {\n    var remaining = hourPrices.filter(function(hp) { return !chargingOffsets[hp.offset]; });\n    remaining.sort(function(a, b) { return a.buy - b.buy; });\n    for (var ri = 0; ri < remaining.length && assignedHours < hoursNeeded; ri++) {\n        chargingOffsets[remaining[ri].offset] = true;\n        assignedHours++;\n    }\n}\n\n// ŽÁDNÝ FALLBACK na drahé hodiny pro běžné nabíjení!\n// Pokud nejsou levné hodiny, nabij méně (nebo vůbec).\nif (assignedHours < hoursNeeded && !maintenanceCharge) {\n    var actualChargeKwh = assignedHours * chargeRateKwh * chargeEfficiency;\n    targetSocFromGrid = Math.min(targetSocFromGrid,\n        currentSoc + Math.round(actualChargeKwh / kapacitaBaterie * 100));\n    gridChargeNeeded = actualChargeKwh;\n}\n\n// === KROK 6: DYNAMICKÝ PRAH_DRAHA ===\n// Cíl: SOC = minSOC těsně před prvním nabíjecím oknem\n\nvar firstChargingOffset = horizont;\nfor (var fco = 0; fco < horizont; fco++) {\n    if (chargingOffsets[fco]) { firstChargingOffset = fco; break; }\n}\n\nvar socToDischarge = Math.max(0, currentSoc - minSoc);\nvar normalHoursNeeded = Math.ceil(socToDischarge / socDropNormal);\n\nvar preChargeHours = [];\nfor (var pc = 0; pc < firstChargingOffset; pc++) {\n    if (!chargingOffsets[pc]) {\n        preChargeHours.push(hourPrices[pc]);\n    }\n}\n\nvar histCorrection = global.get(\"fve_prah_correction\") || 0;\n\nfunction countNormalHours(threshold) {\n    var count = 0;\n    for (var cn = 0; cn < preChargeHours.length; cn++) {\n        if (preChargeHours[cn].levelBuy > threshold) {\n            count++;\n        }\n    }\n    return count;\n}\n\nvar effectivePrahDraha = PRAH_DRAHA + histCorrection;\nvar normalAvailable = countNormalHours(effectivePrahDraha);\n\nif (normalAvailable < normalHoursNeeded && normalHoursNeeded > 0) {\n    while (effectivePrahDraha > PRAH_LEVNA + 1 && normalAvailable < normalHoursNeeded) {\n        effectivePrahDraha--;\n        normalAvailable = countNormalHours(effectivePrahDraha);\n    }\n}\n\nif (normalAvailable > normalHoursNeeded + 1 && normalHoursNeeded > 0) {\n    while (effectivePrahDraha < 20 && normalAvailable > normalHoursNeeded + 1) {\n        effectivePrahDraha++;\n        normalAvailable = countNormalHours(effectivePrahDraha);\n    }\n}\n\neffectivePrahDraha = Math.max(PRAH_LEVNA + 1, Math.min(20, effectivePrahDraha));\n\n// === KROK 7: HISTORICKÉ UČENÍ ===\nvar planLog = global.get(\"fve_plan_log\") || [];\nvar lastChargingSoc = global.get(\"fve_last_charging_soc\") || null;\n\nif (chargingOffsets[0] && lastChargingSoc === null) {\n    global.set(\"fve_last_charging_soc\", currentSoc);\n} else if (!chargingOffsets[0] && lastChargingSoc !== null) {\n    var socAtChargeStart = lastChargingSoc;\n    var diff = socAtChargeStart - minSoc;\n    if (diff > 10) {\n        histCorrection = Math.max(-5, histCorrection - 1);\n        global.set(\"fve_prah_correction\", histCorrection);\n    } else if (diff < 3) {\n        histCorrection = Math.min(5, histCorrection + 1);\n        global.set(\"fve_prah_correction\", histCorrection);\n    }\n    global.set(\"fve_last_charging_soc\", null);\n}\n\n// === KROK 8: VÝPOČET MÓDU PRO KAŽDOU HODINU ===\nfunction calculateModeForHour(offset, priceData, simulatedSoc) {\n    if (manualMod !== \"auto\") {\n        return { mode: manualMod, reason: \"Manuální mód\" };\n    }\n\n    var priceSell = priceData.sell;\n    var levelBuy = priceData.levelBuy;\n    var levelSell = priceData.levelSell;\n\n    // PRIORITA 0: Záporná prodejní cena → zákaz přetoků\n    if (priceSell <= 0) {\n        return { mode: MODY.ZAKAZ_PRETOKU, reason: \"Záporná prodejní cena\" };\n    }\n\n    // PRIORITA 1: Nabíjení ze sítě (pouze finančně smysluplné hodiny)\n    if (chargingOffsets[offset] && simulatedSoc < targetSocFromGrid) {\n        return {\n            mode: MODY.NABIJET_ZE_SITE,\n            reason: \"Nabíjení na cíl \" + targetSocFromGrid + \"% (nyní \" + Math.round(simulatedSoc) + \"%)\"\n        };\n    }\n\n    // PRIORITA 2: Prodej z baterie při výhodné ceně\n    if (prodejZBaterieEnabled && levelSell >= 15 && simulatedSoc > minSoc + 20) {\n        // Finanční kontrola prodeje:\n        // Výnos = prodejní_cena * účinnost_vybíjení\n        // Náklady = průměrná_nákupní_cena / round_trip + amortizace\n        var avgChargeCost = 0;\n        if (viableChargingHours.length > 0) {\n            var s = 0;\n            for (var ac = 0; ac < viableChargingHours.length; ac++) {\n                s += viableChargingHours[ac].buy;\n            }\n            avgChargeCost = s / viableChargingHours.length;\n        }\n        var revenuePerKwh = priceSell * dischargeEfficiency;\n        var costPerKwh = avgChargeCost / roundTripEfficiency + amortizace;\n        if (revenuePerKwh > costPerKwh) {\n            var dischRateKwh = maxFeedInW / 1000;\n            var socAfter = Math.max(minSoc,\n                simulatedSoc - (dischRateKwh / dischargeEfficiency / kapacitaBaterie * 100));\n            return {\n                mode: MODY.PRODAVAT,\n                reason: \"Prodej, SOC \" + Math.round(simulatedSoc) + \"% → ~\" + Math.round(socAfter) + \"%\"\n            };\n        }\n    }\n\n    // PRIORITA 3: Ochrana baterie - příliš nízký SOC\n    if (simulatedSoc <= minSoc + 3) {\n        return {\n            mode: MODY.SETRIT,\n            reason: \"Ochrana baterie (SOC \" + Math.round(simulatedSoc) + \"% blízko min \" + minSoc + \"%)\"\n        };\n    }\n\n    // PRIORITA 4: TŘÍZONOVÝ PRAHOVÝ SYSTÉM\n    // Zóna 1: Levná energie → šetřit baterii\n    if (levelBuy <= PRAH_LEVNA) {\n        return {\n            mode: MODY.SETRIT,\n            reason: \"Levná energie, šetřím baterii (SOC \" + Math.round(simulatedSoc) + \"%)\"\n        };\n    }\n\n    // Zóna 2: Střední cena → šetřit\n    if (levelBuy <= effectivePrahDraha) {\n        return {\n            mode: MODY.SETRIT,\n            reason: \"Střední cena, šetřím baterii (SOC \" + Math.round(simulatedSoc) + \"%)\"\n        };\n    }\n\n    // Zóna 3: Drahá energie → používat baterii\n    // Finanční kontrola: pokud nejsou žádné levné hodiny na dobití, šetři\n    if (assignedHours === 0 && viableChargingHours.length === 0 && !maintenanceCharge) {\n        return {\n            mode: MODY.SETRIT,\n            reason: \"Žádné levné hodiny k nabití, šetřím (SOC \" + Math.round(simulatedSoc) + \"%)\"\n        };\n    }\n\n    var expectedSocAfter = Math.max(minSoc, simulatedSoc - socDropNormal);\n    return {\n        mode: MODY.NORMAL,\n        reason: \"Vybíjení baterie, SOC \" + Math.round(simulatedSoc) + \"% → ~\" + Math.round(expectedSocAfter) + \"%\"\n    };\n}\n\n// === SIMULACE SOC ===\nfunction simulateSocChange(mode, hour, soc) {\n    var isSolar = hour >= 9 && hour < 17;\n    switch (mode) {\n        case MODY.NABIJET_ZE_SITE:\n            return Math.min(100, soc + (chargeRateKwh * chargeEfficiency / kapacitaBaterie * 100));\n        case MODY.PRODAVAT:\n            var dischRateKwh = maxFeedInW / 1000;\n            return Math.max(minSoc, soc - (dischRateKwh / dischargeEfficiency / kapacitaBaterie * 100));\n        case MODY.SETRIT:\n        case MODY.ZAKAZ_PRETOKU:\n            return Math.max(minSoc, soc - 1);\n        case MODY.NORMAL:\n            if (isSolar && remainingSolarKwh > 0) {\n                return Math.min(100, soc + 3);\n            }\n            return Math.max(minSoc, soc - socDropNormal);\n        default:\n            return soc;\n    }\n}\n\n// === GENEROVÁNÍ PLÁNU ===\nvar modeNamesCZ = {\n    normal: \"Normální provoz\",\n    setrit: \"Šetřit baterii\",\n    nabijet_ze_site: \"Nabíjet ze sítě\",\n    prodavat: \"Prodávat do sítě\",\n    zakaz_pretoku: \"Zákaz přetoků\"\n};\n\nvar plan = [];\nvar simulatedSoc = currentSoc;\n\nfor (var pi = 0; pi < horizont; pi++) {\n    var planHour = (currentHour + pi) % 24;\n    var isNextDay = (currentHour + pi) >= 24;\n    var priceData = getPriceDataForHour(planHour);\n    var result = calculateModeForHour(pi, priceData, simulatedSoc);\n    simulatedSoc = simulateSocChange(result.mode, planHour, simulatedSoc);\n    plan.push({\n        hour: planHour,\n        offset: pi,\n        mode: result.mode,\n        modeCZ: modeNamesCZ[result.mode] || result.mode,\n        reason: result.reason,\n        priceLevel: priceData.levelBuy,\n        priceBuy: priceData.buy,\n        priceSell: priceData.sell,\n        simulatedSoc: Math.round(simulatedSoc),\n        isNextDay: isNextDay,\n        isChargingHour: chargingOffsets[pi] || false\n    });\n}\n\n// === LOGOVÁNÍ PLÁNU ===\nvar logEntry = {\n    timestamp: now.toISOString(),\n    hour: currentHour,\n    soc: currentSoc,\n    effectivePrahDraha: effectivePrahDraha,\n    histCorrection: histCorrection,\n    normalHoursNeeded: normalHoursNeeded,\n    normalHoursAvailable: normalAvailable,\n    remainingSolar: remainingSolarKwh,\n    gridChargeNeeded: Math.round(gridChargeNeeded * 10) / 10,\n    roundTripEfficiency: Math.round(roundTripEfficiency * 100),\n    plan: plan.map(function(p) {\n        return { h: p.hour, m: p.mode, l: p.priceLevel, soc: p.simulatedSoc };\n    })\n};\nplanLog.push(logEntry);\nif (planLog.length > 48) { planLog = planLog.slice(-48); }\nglobal.set(\"fve_plan_log\", planLog);\n\n// === VÝSTUP ===\nvar currentMode = plan.length > 0 ? plan[0].mode : MODY.NORMAL;\nvar currentReason = plan.length > 0 ? plan[0].reason : \"\";\n\nvar countSetrit = 0, countNormal = 0, countNabijet = 0;\nfor (var cs = 0; cs < plan.length; cs++) {\n    if (plan[cs].mode === MODY.SETRIT) countSetrit++;\n    else if (plan[cs].mode === MODY.NORMAL) countNormal++;\n    else if (plan[cs].mode === MODY.NABIJET_ZE_SITE) countNabijet++;\n}\n\nmsg.payload = {\n    currentMode: currentMode,\n    currentReason: currentReason,\n    currentHour: currentHour,\n    plan: plan,\n    config: { prah_levna: PRAH_LEVNA, prah_draha: PRAH_DRAHA },\n    dynamicThreshold: {\n        configPrahDraha: PRAH_DRAHA,\n        effectivePrahDraha: effectivePrahDraha,\n        histCorrection: histCorrection,\n        normalHoursNeeded: normalHoursNeeded,\n        normalHoursAvailable: normalAvailable,\n        firstChargingOffset: firstChargingOffset\n    },\n    smartCharging: {\n        targetSocFromGrid: targetSocFromGrid,\n        gridChargeNeeded: Math.round(gridChargeNeeded * 10) / 10,\n        hoursNeeded: hoursNeeded,\n        assignedHours: assignedHours,\n        viableHoursAvailable: viableChargingHours.length,\n        remainingSolar: Math.round(remainingSolarKwh * 10) / 10,\n        solarForBattery: Math.round(solarForBattery * 10) / 10,\n        dailyConsumption: dailyConsumptionKwh,\n        batteryNeed: Math.round(batteryNeedKwh * 10) / 10,\n        roundTripEfficiency: Math.round(roundTripEfficiency * 100),\n        amortizace: amortizace,\n        daysToFullCharge: daysSinceFullCharge,\n        maintenanceCharge: maintenanceCharge\n    },\n    planSummary: {\n        setritHours: countSetrit,\n        normalHours: countNormal,\n        nabijetHours: countNabijet\n    },\n    status: {\n        soc: currentSoc,\n        remainingSolar: remainingSolarKwh,\n        forecastDnes: remainingSolarKwh,\n        forecastZitra: forecastZitra,\n        prodejEnabled: prodejZBaterieEnabled,\n        blokaceVybijeni: blokaceVybijeni\n    },\n    generatedAt: now.toISOString()\n};\n\nvar modeColors = {\n    normal: \"green\",\n    setrit: \"yellow\",\n    nabijet_ze_site: \"blue\",\n    prodavat: \"red\",\n    zakaz_pretoku: \"purple\"\n};\nnode.status({\n    fill: modeColors[currentMode] || \"grey\",\n    shape: \"dot\",\n    text: currentMode\n        + \" | efPráh:\" + effectivePrahDraha\n        + \"(cfg:\" + PRAH_DRAHA + \" kor:\" + histCorrection + \")\"\n        + \" | S:\" + countSetrit + \" N:\" + countNormal + \" Nab:\" + countNabijet\n        + \" | SOC:\" + currentSoc + \"%→\" + targetSocFromGrid + \"%\"\n        + \" | RT:\" + Math.round(roundTripEfficiency * 100) + \"%\"\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 60,
        "wires": [
            [
                "df085ac4da095340",
                "39019d1a78677231"
            ]
        ]
    },
    {
        "id": "df085ac4da095340",
        "type": "function",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "Ulož plán",
        "func": "global.set(\"fve_plan\", msg.payload);\nglobal.set(\"fve_current_mode\", msg.payload.currentMode);\n\nmsg.ha_update = {\n    state: msg.payload.currentMode,\n    attributes: {\n        current_mode: msg.payload.currentMode,\n        current_reason: msg.payload.currentReason,\n        current_hour: msg.payload.currentHour,\n        plan: msg.payload.plan,\n        soc: msg.payload.status.soc,\n        forecast_dnes: msg.payload.status.forecastDnes,\n        forecast_zitra: msg.payload.status.forecastZitra,\n        last_update: msg.payload.generatedAt\n    }\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 60,
        "wires": [
            [
                "517215d5f730e80c"
            ]
        ]
    },
    {
        "id": "39019d1a78677231",
        "type": "debug",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "Plan Debug",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 310,
        "y": 140,
        "wires": []
    },
    {
        "id": "517215d5f730e80c",
        "type": "function",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "Aktualizuj HA sensor",
        "func": "var planData = msg.payload || {};\nvar currentMode = planData.currentMode || \"normal\";\nvar currentHour = planData.currentHour || new Date().getHours();\nvar planArray = planData.plan || [];\n\nnode.status({fill:\"green\", shape:\"dot\", text: \"Mód: \" + currentMode + \", hodina: \" + currentHour});\n\nmsg.payload = JSON.stringify({\n    current_mode: currentMode,\n    current_hour: currentHour,\n    plan: planArray,\n    last_update: new Date().toISOString()\n}, null, 2);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 140,
        "wires": [
            [
                "701e94d82c3aead0"
            ]
        ]
    },
    {
        "id": "701e94d82c3aead0",
        "type": "file",
        "z": "d86bb11fab512182",
        "g": "4580a451a0858d03",
        "name": "Zapiš plán do souboru",
        "filename": "/homeassistant/fve_plan.json",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "true",
        "encoding": "utf8",
        "x": 840,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "44d31ff3c04741b7",
        "type": "inject",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "Každých 15 sekund",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "15",
        "crontab": "",
        "once": true,
        "onceDelay": "20",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 220,
        "y": 280,
        "wires": [
            [
                "c36915a8599c5282"
            ]
        ]
    },
    {
        "id": "c36915a8599c5282",
        "type": "function",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "Kontrola podmínek",
        "func": "var config = global.get(\"fve_config\") || {};\nvar plan = global.get(\"fve_plan\") || {};\nvar planMode = global.get(\"fve_current_mode\") || \"normal\";\nvar manualMod = config.manual_mod || \"auto\";\n\nvar currentMode = planMode;\nif (manualMod !== \"auto\") {\n    currentMode = manualMod;\n}\n\nvar wasEnabled = flow.get(\"automatizace_was_enabled\") || false;\nif (config.automatizace_enabled === false) {\n    if (wasEnabled) {\n        flow.set(\"automatizace_was_enabled\", false);\n        global.set(\"fve_current_mode\", \"normal\");\n        msg.currentMode = \"normal\";\n        msg.doReset = true;\n        node.status({fill:\"yellow\", shape:\"dot\", text:\"Reset do normalniho modu\"});\n        return msg;\n    }\n    node.status({fill:\"grey\", shape:\"ring\", text:\"Automatizace vypnuta\"});\n    return null;\n}\nflow.set(\"automatizace_was_enabled\", true);\n\nvar autoNabijeni = global.get(\"auto_nabijeni_aktivni\") || false;\nvar cerpadloTopi = global.get(\"cerpadlo_topi\") || false;\n\n// Ochrana baterie: pri topeni/TUV nebo nabijeni auta blokovat vybijeni\nvar overridden = false;\nif ((cerpadloTopi || autoNabijeni) && currentMode === \"normal\") {\n    currentMode = \"setrit\";\n    overridden = true;\n}\n\n// Aktualizuj skutecny mod v globalni promenne (aby HA ukazoval realitu)\nglobal.set(\"fve_current_mode\", currentMode);\n\nmsg.autoNabijeniAktivni = autoNabijeni;\nmsg.cerpadloTopi = cerpadloTopi;\nmsg.currentMode = currentMode;\nmsg.config = config;\nmsg.plan = plan;\n\nvar modeSource = manualMod !== \"auto\" ? \"(manualni)\" : \"(auto)\";\nvar protectText = \"\";\nif (overridden) protectText += \" | OVERRIDE z \" + planMode;\nif (cerpadloTopi) protectText += \" | Cerpadlo topi\";\nif (autoNabijeni) protectText += \" | Auto nabiji\";\nnode.status({fill: manualMod !== \"auto\" ? \"blue\" : \"green\", shape:\"dot\", text: \"Mod: \" + currentMode + \" \" + modeSource + protectText});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 280,
        "wires": [
            [
                "8eef6d1d51c9c644"
            ]
        ]
    },
    {
        "id": "8eef6d1d51c9c644",
        "type": "function",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "Rozhodnutí o akci",
        "func": "var mode = msg.currentMode;\nvar skipBattery = msg.skipBatteryControl || false;\n\nswitch (mode) {\n    case \"normal\": msg.modeIndex = 0; break;\n    case \"setrit\": msg.modeIndex = 1; break;\n    case \"nabijet_ze_site\": msg.modeIndex = 2; break;\n    case \"prodavat\": msg.modeIndex = 3; break;\n    case \"zakaz_pretoku\": msg.modeIndex = 4; break;\n    default: msg.modeIndex = 0;\n}\n\nmsg.skipBatteryControl = skipBattery;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 360,
        "wires": [
            [
                "19a783a61de3519b"
            ]
        ]
    },
    {
        "id": "19a783a61de3519b",
        "type": "switch",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "Směrování podle módu",
        "property": "modeIndex",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "3",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "4",
                "vt": "num"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 5,
        "x": 610,
        "y": 360,
        "wires": [
            [
                "f10a91fcb4de6bd3"
            ],
            [
                "7f051a6595e57c3e"
            ],
            [
                "185f95d7c56fe799"
            ],
            [
                "a706b353f30c25d1"
            ],
            [
                "a86bc5233cfa0458"
            ]
        ]
    },
    {
        "id": "f10a91fcb4de6bd3",
        "type": "link out",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "→ Normal",
        "mode": "link",
        "links": [
            "8b55cfc5181b9eb7"
        ],
        "x": 785,
        "y": 280,
        "wires": []
    },
    {
        "id": "7f051a6595e57c3e",
        "type": "link out",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "→ Šetřit",
        "mode": "link",
        "links": [
            "ec611f6aba7d5c59"
        ],
        "x": 785,
        "y": 320,
        "wires": []
    },
    {
        "id": "185f95d7c56fe799",
        "type": "link out",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "→ Nabíjet",
        "mode": "link",
        "links": [
            "1d98a0541716ce58"
        ],
        "x": 785,
        "y": 360,
        "wires": []
    },
    {
        "id": "a706b353f30c25d1",
        "type": "link out",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "→ Prodávat",
        "mode": "link",
        "links": [
            "179ed150020d459c"
        ],
        "x": 785,
        "y": 400,
        "wires": []
    },
    {
        "id": "a86bc5233cfa0458",
        "type": "link out",
        "z": "d86bb11fab512182",
        "g": "c0d4d6462d4ebded",
        "name": "→ Zákaz přetoků",
        "mode": "link",
        "links": [
            "c682224043634fcd"
        ],
        "x": 785,
        "y": 440,
        "wires": []
    },
    {
        "id": "fc848e97e2c781c1",
        "type": "server-state-changed",
        "z": "d86bb11fab512182",
        "g": "66210c073baa5af0",
        "name": "Změna stavu wallboxu",
        "server": "c7421fe2.cb11c",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.stav_wallboxu_garaz_popis",
                "sensor.stav_wallboxu_venek_popis"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": true,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "entity_id",
                "propertyType": "msg",
                "value": "",
                "valueType": "str"
            }
        ],
        "x": 240,
        "y": 580,
        "wires": [
            [
                "376106d716756636"
            ]
        ]
    },
    {
        "id": "376106d716756636",
        "type": "function",
        "z": "d86bb11fab512182",
        "g": "66210c073baa5af0",
        "name": "Kontrola nabíjení auta",
        "func": "var state = msg.payload;\nvar chargingStates = [\"Charging\", \"Nabíjení\", \"2\"];\nvar isCharging = chargingStates.some(function(s) {\n    return state.toLowerCase().indexOf(s.toLowerCase()) !== -1 || state === s;\n});\nmsg.autoNabijeni = isCharging;\nnode.status({fill: isCharging ? \"yellow\" : \"green\", shape:\"dot\", text: isCharging ? \"Auto se nabíjí\" : \"Auto se nenabíjí\"});\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 472,
        "y": 580,
        "wires": [
            [
                "dc8da09248ec1e29"
            ]
        ]
    },
    {
        "id": "dc8da09248ec1e29",
        "type": "change",
        "z": "d86bb11fab512182",
        "g": "66210c073baa5af0",
        "name": "Nastav global",
        "rules": [
            {
                "t": "set",
                "p": "auto_nabijeni_aktivni",
                "pt": "global",
                "to": "autoNabijeni",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 680,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "c7421fe2.cb11c",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "78d719aa6ebb1122",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3"
        }
    }
]